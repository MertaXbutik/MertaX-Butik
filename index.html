<!doctype html>
<html lang="mk">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MertaX Butik</title>

  <style>
    :root{
      --bg:#f6f7fb; --card:#ffffff; --muted:#6b7280; --txt:#111827;
      --accent:#16a34a; --danger:#dc2626; --chip:#f3f4f6; --border:#e5e7eb;
      --shadow:0 10px 26px rgba(0,0,0,.08); --radius:18px;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Arial,sans-serif;background:var(--bg);color:var(--txt)}
    header{background:#fff;padding:14px;position:sticky;top:0;z-index:50;border-bottom:1px solid var(--border)}
    .headRow{max-width:1100px;margin:0 auto;display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap}
    .brand{font-size:22px;font-weight:900;letter-spacing:.6px}
    .headBtns{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .btn{border:1px solid var(--border);cursor:pointer;padding:11px 13px;border-radius:14px;font-weight:800;background:#fff;color:var(--txt);transition:.18s}
    .btn:hover{transform:translateY(-2px);box-shadow:var(--shadow)}
    .btn-accent{background:var(--accent);color:#fff;border-color:transparent}
    .btn-danger{background:var(--danger);color:#fff;border-color:transparent}
    .btn-ghost{background:transparent}
    .wrap{max-width:1100px;margin:0 auto;padding:14px}

    .topbar{display:flex;gap:10px;align-items:flex-start;justify-content:space-between;flex-wrap:wrap;margin:12px 0 12px}
    .badge{background:#fff;border:1px solid var(--border);padding:10px 12px;border-radius:14px;display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .small{font-size:12px;color:var(--muted)}
    .filters{display:flex;gap:10px;flex-wrap:wrap;align-items:flex-start;justify-content:flex-end;flex:1}
    .inp,.sel,.ta{width:100%;padding:12px;border-radius:14px;border:1px solid var(--border);background:#fff;color:var(--txt);outline:none}
    .ta{min-height:90px;resize:vertical}
    .filters .block{display:flex;flex-direction:column;gap:6px}
    .lbl{font-size:12px;color:var(--muted);font-weight:700;margin-left:4px}

    .grid{display:grid;grid-template-columns:repeat(2,1fr);gap:12px}
    @media(min-width:820px){.grid{grid-template-columns:repeat(4,1fr)}}

    .card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);overflow:hidden;box-shadow:var(--shadow);transition:.18s;position:relative}
    .card:hover{transform:translateY(-4px)}
    .imgWrap{position:relative}
    .img{width:100%;aspect-ratio:1/1;object-fit:cover;display:block;background:#eee}
    .tagRow{position:absolute;left:10px;top:10px;display:flex;gap:8px;flex-wrap:wrap}
    .tag{font-size:11px;font-weight:900;letter-spacing:.4px;padding:6px 10px;border-radius:999px;background:#f3f4f6;border:1px solid var(--border)}
    .tag-new{background:#dcfce7;color:#166534;border-color:transparent}
    .tag-sale{background:#fee2e2;color:#991b1b;border-color:transparent}

    .p{padding:12px}
    .name{margin:0 0 8px;font-weight:900;font-size:14px}
    .priceLine{display:flex;align-items:baseline;gap:8px;margin:0 0 10px;flex-wrap:wrap}
    .priceNow{font-weight:900;font-size:16px}
    .priceOld{color:var(--muted);text-decoration:line-through;font-size:13px}
    .miniRow{display:flex;gap:8px;align-items:center;justify-content:space-between;flex-wrap:wrap}
    .miniSel{min-width:150px}

    .center{display:flex;justify-content:center;margin:14px 0}
    .overlay{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;z-index:90}
    .overlay.show{display:block}

    .drawer{
      position:fixed;right:0;top:0;height:100%;width:min(420px,92vw);
      background:#fff;border-left:1px solid var(--border);
      transform:translateX(110%);transition:.25s;z-index:95;display:flex;flex-direction:column
    }
    .drawer.open{transform:translateX(0)}
    .drawerHead{display:flex;align-items:center;justify-content:space-between;gap:10px;padding:14px;border-bottom:1px solid var(--border)}
    .drawerHead h2{margin:0;font-size:18px}
    .xbtn{background:var(--chip);border:1px solid var(--border);color:var(--txt);width:38px;height:38px;border-radius:12px;cursor:pointer;font-size:18px}
    .cartlist{padding:10px 14px;overflow:auto;flex:1}
    .item{display:flex;gap:10px;padding:10px 0;border-bottom:1px solid var(--border)}
    .thumb{width:56px;height:56px;border-radius:14px;object-fit:cover;background:#eee}
    .itxt{flex:1}
    .itxt b{display:block;font-size:13px;margin-bottom:4px}
    .qty{display:flex;gap:6px;align-items:center;flex-wrap:wrap}
    .qty button{width:34px;height:34px;border-radius:12px;border:1px solid var(--border);background:#fff;color:var(--txt);font-size:18px;cursor:pointer}
    .foot{padding:12px 14px;border-top:1px solid var(--border)}
    .foot .line{display:flex;justify-content:space-between;margin:8px 0;color:#111}
    .foot .line b{color:#111}

    .modal{
      position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);
      width:min(860px,92vw);
      background:#fff;border:1px solid var(--border);
      border-radius:var(--radius);z-index:100;display:none;box-shadow:var(--shadow)
    }
    .modal.show{display:block}
    .modalHead{padding:14px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;gap:10px}
    .modalHead h3{margin:0;font-size:18px}
    .modalBody{padding:14px; max-height:72vh; overflow:auto;}
    .form{display:grid;gap:10px}
    .two{display:grid;gap:10px;grid-template-columns:1fr 1fr}
    .three{display:grid;gap:10px;grid-template-columns:1fr 1fr 1fr}
    @media(max-width:700px){.three{grid-template-columns:1fr}}
    @media(max-width:520px){.two{grid-template-columns:1fr}}
    .hr{height:1px;background:var(--border);margin:8px 0}
    .listRow{display:flex;gap:10px;align-items:center;justify-content:space-between;padding:10px 0;border-bottom:1px solid var(--border);flex-wrap:wrap}
    .pill{font-size:11px;padding:6px 10px;border-radius:999px;border:1px solid var(--border);background:var(--chip);color:var(--txt)}
  </style>
</head>

<body>
<header>
  <div class="headRow">
    <div class="brand">MertaX Butik</div>
    <div class="headBtns">
      <button class="btn btn-ghost" id="adminBtn">Admin</button>
      <button class="btn" id="openCartBtn">–ö–æ—à–Ω–∏—á–∫–∞</button>
      <button class="btn btn-danger" id="clearCartBtn">–ò—Å–ø—Ä–∞–∑–Ω–∏</button>
    </div>
  </div>
</header>

<div class="wrap">
  <div class="topbar">
    <div class="badge">
      üõí <span>–ö–æ—à–Ω–∏—á–∫–∞:</span> <b id="cartCount">0</b>
      <span class="small">| –í–∫—É–ø–Ω–æ: <b id="cartTotal">0</b> –¥–µ–Ω.</span>
    </div>

    <div class="filters">
      <div class="block" style="max-width:320px;">
        <div class="lbl">–ü—Ä–µ–±–∞—Ä–∞—ò</div>
        <input class="inp" id="searchInp" placeholder="–ü—Ä–µ–±–∞—Ä–∞—ò –ø–æ –∏–º–µ..." />
      </div>

      <div class="block" style="max-width:260px;">
        <div class="lbl">–ö–∞—Ç–µ–≥–æ—Ä–∏—ò–∞</div>
        <select class="sel" id="catSel"></select>
      </div>

      <div class="block" style="max-width:220px;">
        <div class="lbl">–ì–æ–ª–µ–º–∏–Ω–∞</div>
        <select class="sel" id="sizeFilterSel"></select>
      </div>

      <div class="block" style="max-width:160px;">
        <div class="lbl">–¶–µ–Ω–∞ –æ–¥</div>
        <input class="inp" id="minPriceInp" inputmode="numeric" placeholder="0" />
      </div>

      <div class="block" style="max-width:160px;">
        <div class="lbl">–¶–µ–Ω–∞ –¥–æ</div>
        <input class="inp" id="maxPriceInp" inputmode="numeric" placeholder="99999" />
      </div>

      <div class="block" style="max-width:220px;">
        <div class="lbl">–°–æ—Ä—Ç–∏—Ä–∞—ö–µ</div>
        <select class="sel" id="sortSel">
          <option value="default">–°—Ç–∞–Ω–¥–∞—Ä–¥–Ω–æ</option>
          <option value="price_asc">–¶–µ–Ω–∞ ‚Üë</option>
          <option value="price_desc">–¶–µ–Ω–∞ ‚Üì</option>
          <option value="new_first">–ù–û–í–û –ø—Ä–≤–æ</option>
          <option value="sale_first">–ê–ö–¶–ò–à–ê –ø—Ä–≤–æ</option>
          <option value="name_asc">–ò–º–µ A‚ÜíZ</option>
        </select>
      </div>
    </div>

    <div class="small">WhatsApp: <b>+38972912601</b> ‚Ä¢ –õ–æ–∫–∞—Ü–∏—ò–∞: <b>–¢–¶ –ú–∞–≤—Ä–æ–≤–∫–∞</b></div>
  </div>

  <div class="small" id="infoLine"></div>
  <div class="grid" id="productGrid"></div>

  <div class="center">
    <button class="btn btn-ghost" id="loadMoreBtn" style="display:none;">–í—á–∏—Ç–∞—ò —É—à—Ç–µ</button>
  </div>
</div>

<div class="overlay" id="overlay"></div>

<!-- Cart drawer -->
<aside class="drawer" id="drawer">
  <div class="drawerHead">
    <h2>–¢–≤–æ—ò–∞ –∫–æ—à–Ω–∏—á–∫–∞</h2>
    <button class="xbtn" id="closeCartBtn">‚úï</button>
  </div>
  <div class="cartlist" id="cartList"></div>
  <div class="foot">
    <div class="line"><span>–ü—Ä–æ–∏–∑–≤–æ–¥–∏</span> <b id="sumItems">0</b></div>
    <div class="line"><span>–î–æ—Å—Ç–∞–≤–∞</span> <b id="shipLine">0 –¥–µ–Ω.</b></div>
    <div class="line"><span>–í–∫—É–ø–Ω–æ</span> <b><span id="sumTotal">0</span> –¥–µ–Ω.</b></div>
    <button class="btn btn-accent" id="goCheckoutBtn" style="width:100%;">–ü—Ä–æ–¥–æ–ª–∂–∏ –Ω–∞ –Ω–∞—Ä–∞—á–∫–∞</button>
  </div>
</aside>

<!-- Checkout modal -->
<div class="modal" id="checkoutModal">
  <div class="modalHead">
    <h3>–ù–∞—Ä–∞—á–∫–∞</h3>
    <button class="xbtn" id="closeCheckoutBtn">‚úï</button>
  </div>
  <div class="modalBody">
    <div class="small">–ë—Ä–æ—ò –Ω–∞ –Ω–∞—Ä–∞—á–∫–∞: <b id="orderIdText">-</b></div>
    <div class="hr"></div>

    <div class="form">
      <input class="inp" id="custName" placeholder="–ò–º–µ –∏ –ø—Ä–µ–∑–∏–º–µ" />
      <input class="inp" id="custPhone" placeholder="–¢–µ–ª–µ—Ñ–æ–Ω (–ø—Ä–∏–º–µ—Ä: 07X XXX XXX)" />

      <div class="two">
        <select class="sel" id="paymentSel">
          <option value="–ì–æ—Ç–æ–≤–æ –ø—Ä–∏ –ø—Ä–∏–µ–º">–ì–æ—Ç–æ–≤–æ –ø—Ä–∏ –ø—Ä–∏–µ–º</option>
        </select>
        <select class="sel" id="exchangeSel">
          <option value="–î–∞">–ú–æ–∂–Ω–æ—Å—Ç –∑–∞ –∑–∞–º–µ–Ω–∞: –î–∞</option>
          <option value="–ù–µ">–ú–æ–∂–Ω–æ—Å—Ç –∑–∞ –∑–∞–º–µ–Ω–∞: –ù–µ</option>
        </select>
      </div>

      <div class="two">
        <select class="sel" id="deliverySel">
          <option value="–î–∞">–î–æ—Å—Ç–∞–≤–∞: –î–∞ (+150 –¥–µ–Ω)</option>
          <option value="–ù–µ">–î–æ—Å—Ç–∞–≤–∞: –ù–µ (0 –¥–µ–Ω)</option>
        </select>
        <input class="inp" id="deliveryAddress" placeholder="–ê–¥—Ä–µ—Å–∞ –∑–∞ –¥–æ—Å—Ç–∞–≤–∞ (–∞–∫–æ –µ –î–∞)" />
      </div>

      <textarea class="ta" id="custNote" placeholder="–ù–∞–ø–æ–º–µ–Ω–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª–Ω–æ)"></textarea>

      <div class="small">–ê–∫–æ –µ –±–µ–∑ –¥–æ—Å—Ç–∞–≤–∞, –ø–æ–¥–∏–≥–∞—ö–µ: <b>–¢–¶ –ú–∞–≤—Ä–æ–≤–∫–∞</b>. –å–µ —Å–µ –æ—Ç–≤–æ—Ä–∏ WhatsApp —Å–æ –≥–æ—Ç–æ–≤–∞ –ø–æ—Ä–∞–∫–∞.</div>
      <button class="btn btn-accent" id="sendWhatsappBtn">–ò—Å–ø—Ä–∞—Ç–∏ –Ω–∞ WhatsApp</button>
    </div>
  </div>
</div>

<!-- Admin modal -->
<div class="modal" id="adminModal">
  <div class="modalHead">
    <h3>Admin –ø–∞–Ω–µ–ª</h3>
    <button class="xbtn" id="closeAdminBtn">‚úï</button>
  </div>
  <div class="modalBody">
    <div id="adminLoginBox">
      <div class="small">–í–Ω–µ—Å–∏ PIN –∑–∞ Admin (default: 1234)</div>
      <div class="two" style="margin-top:10px;">
        <input class="inp" id="adminPinInp" placeholder="PIN" type="password" />
        <button class="btn btn-accent" id="adminLoginBtn">–í–ª–µ–∑–∏</button>
      </div>
    </div>

    <div id="adminPanelBox" style="display:none;">
      <div class="three">
        <button class="btn btn-ghost" id="clearOverridesBtn">Reset demo overrides</button>
        <button class="btn btn-ghost" id="clearCustomBtn">–ò–∑–±—Ä–∏—à–∏ –°–ò–¢–ï custom –ø—Ä–æ–∏–∑–≤–æ–¥–∏</button>
        <button class="btn btn-ghost" id="changePinBtn">–ü—Ä–æ–º–µ–Ω–∏ PIN</button>
      </div>

      <div class="hr"></div>

      <div class="small"><b>–î–æ–¥–∞—ò / –ò–∑–º–µ–Ω–∏ –ø—Ä–æ–∏–∑–≤–æ–¥</b></div>
      <div class="form" style="margin-top:10px;">
        <div class="two">
          <input class="inp" id="pId" placeholder="ID (–æ—Å—Ç–∞–≤–∏ –ø—Ä–∞–∑–Ω–æ –∑–∞ –Ω–æ–≤)" />
          <input class="inp" id="pName" placeholder="–ò–º–µ –Ω–∞ –ø—Ä–æ–∏–∑–≤–æ–¥" />
        </div>

        <div class="three">
          <select class="sel" id="pCat"></select>
          <input class="inp" id="pPrice" placeholder="–¶–µ–Ω–∞ (–¥–µ–Ω)" inputmode="numeric" />
          <input class="inp" id="pOldPrice" placeholder="–°—Ç–∞—Ä–∞ —Ü–µ–Ω–∞ (–æ–ø—Ü.)" inputmode="numeric" />
        </div>

        <div class="three">
          <select class="sel" id="pBadge">
            <option value="">–ë–µ–∑ –æ–∑–Ω–∞–∫–∞</option>
            <option value="–ù–û–í–û">–ù–û–í–û</option>
            <option value="–ê–ö–¶–ò–à–ê">–ê–ö–¶–ò–à–ê</option>
          </select>

          <input class="inp" id="pImg" placeholder="–°–ª–∏–∫–∞ URL (–æ–ø—Ü.) –∏–ª–∏ —ú–µ —Å–µ –ø–æ–ø–æ–ª–Ω–∏ –æ–¥ Upload" />
          <input class="inp" id="pSizes" placeholder="–ì–æ–ª–µ–º–∏–Ω–∏ (–∑–∞–ø–∏—Ä–∫–∞) –ø—Ä–∏–º–µ—Ä: S,M,L,XL,2XL,3XL –∏–ª–∏ 30,31..42" />
        </div>

        <div class="three">
          <input class="inp" id="pImgFile" type="file" accept="image/*" />
          <input class="inp" id="pImgCam" type="file" accept="image/*" capture="environment" />
          <div class="small" style="align-self:center;">
            1) Upload –æ–¥ Gallery<br>
            2) <b>–ö–∞—á–∏ —Å–ª–∏–∫–∞ –æ–¥ –∫–∞–º–µ—Ä–∞</b>
          </div>
        </div>

        <img id="imgPreview" style="width:100%; max-width:240px; margin-top:8px; border-radius:14px; display:none; border:1px solid var(--border);" />

        <div class="two">
          <button class="btn btn-accent" id="saveProductBtn">–°–Ω–∏–º–∏</button>
          <button class="btn btn-danger" id="deleteProductBtn">–ò–∑–±—Ä–∏—à–∏ (ID)</button>
        </div>
        <div class="small" id="adminMsg"></div>
      </div>

      <div class="hr"></div>

      <div class="two">
        <select class="sel" id="adminFilterCat"></select>
        <input class="inp" id="adminSearch" placeholder="–ü—Ä–µ–±–∞—Ä–∞—ò (custom + demo)..." />
      </div>

      <div class="small" style="margin-top:10px;"><b>–õ–∏—Å—Ç–∞ (–ø—Ä–≤–∏ 200 —Ä–µ–∑—É–ª—Ç–∞—Ç–∏)</b></div>
      <div id="adminList"></div>

      <div class="hr"></div>

      <div class="small"><b>Export / Import</b></div>
      <div class="two" style="margin-top:10px;">
        <button class="btn btn-ghost" id="exportBtn">–ö–æ–ø–∏—Ä–∞—ò JSON (Export)</button>
        <button class="btn btn-ghost" id="importBtn">–í–Ω–µ—Å–∏ JSON (Import)</button>
      </div>
      <textarea class="ta" id="jsonBox" placeholder="–¢—É–∫–∞ —ú–µ —Å–µ –ø–æ—ò–∞–≤–∏ JSON (Export) –∏–ª–∏ –∑–∞–ª–µ–ø–∏ JSON –∑–∞ Import..."></textarea>
    </div>
  </div>
</div>

<script>
  // ===== SETTINGS =====
  const WHATSAPP_NUMBER = "38972912601";
  const STORE_LOCATION = "–¢–¶ –ú–∞–≤—Ä–æ–≤–∫–∞";
  const SHIPPING_FEE = 150;

  const PAGE_SIZE = 30;
  const MAX_PER_CATEGORY = 150;

  const DEFAULT_SIZES = ["S","M","L","XL","2XL","3XL"];
  const JEANS_SIZES = Array.from({length: 13}, (_,i)=> String(30+i)); // 30..42

  const CATEGORIES = [
    "–è–µ–º–ø–µ—Ä–∏","–ë–ª—É–∑–æ–Ω–∏","–ú–∞–∏—Ü–∏","–ö–æ—à—É–ª–∏",
    "–§–∞—Ä–º–µ—Ä–∫–∏/–ü–∞–Ω—Ç–∞–ª–æ–Ω–∏","–¢—Ä–µ–Ω–µ—Ä–∫–∏","–à–∞–∫–Ω–∏","–û–¥–µ–ª–∞"
  ];

  // Storage keys
  const CART_KEY = "mertax_cart_v200";
  const ADMIN_PIN_KEY = "mertax_admin_pin_v1";
  const CUSTOM_KEY = "mertax_custom_products_v1";
  const DELETED_KEY = "mertax_deleted_ids_v1";

  const round10 = (n)=> Math.round(n/10)*10;

  function catKey(cat){
    return cat.toLowerCase()
      .replaceAll(" ","-").replaceAll("/","-")
      .replaceAll("—ú","k").replaceAll("—ü","dz").replaceAll("–∂","zh")
      .replaceAll("—á","ch").replaceAll("—à","sh")
      .replaceAll("—ô","lj").replaceAll("—ö","nj")
      .replaceAll("—ì","gj").replaceAll("—ï","dz")
      .replaceAll("–∞","a").replaceAll("–±","b").replaceAll("–≤","v").replaceAll("–≥","g")
      .replaceAll("–¥","d").replaceAll("–µ","e").replaceAll("–∑","z").replaceAll("–∏","i")
      .replaceAll("—ò","j").replaceAll("–∫","k").replaceAll("–ª","l").replaceAll("–º","m")
      .replaceAll("–Ω","n").replaceAll("–æ","o").replaceAll("–ø","p").replaceAll("—Ä","r")
      .replaceAll("—Å","s").replaceAll("—Ç","t").replaceAll("—É","u").replaceAll("—Ñ","f")
      .replaceAll("—Ö","h").replaceAll("—Ü","c");
  }

  function demoImg(seed){
    return `https://picsum.photos/seed/${encodeURIComponent(seed)}/900/900`;
  }

  function priceByCategory(cat){
    switch(cat){
      case "–ú–∞–∏—Ü–∏": return 990;
      case "–ö–æ—à—É–ª–∏": return 1490;
      case "–è–µ–º–ø–µ—Ä–∏": return 1890;
      case "–ë–ª—É–∑–æ–Ω–∏": return 2190;
      case "–§–∞—Ä–º–µ—Ä–∫–∏/–ü–∞–Ω—Ç–∞–ª–æ–Ω–∏": return 1990;
      case "–¢—Ä–µ–Ω–µ—Ä–∫–∏": return 2290;
      case "–à–∞–∫–Ω–∏": return 3990;
      case "–û–¥–µ–ª–∞": return 7990;
      default: return 1490;
    }
  }

  function sizesByCategory(cat){
    return (cat === "–§–∞—Ä–º–µ—Ä–∫–∏/–ü–∞–Ω—Ç–∞–ª–æ–Ω–∏") ? JEANS_SIZES.slice() : DEFAULT_SIZES.slice();
  }

  function makeId(){
    const rnd = Math.random().toString(16).slice(2,8).toUpperCase();
    const t = Date.now().toString(16).slice(-6).toUpperCase();
    return `mx_${t}_${rnd}`;
  }

  // ===== LAZY DEMO =====
  function demoProduct(cat, idx1){
    const basePrice = priceByCategory(cat);
    const price = round10(basePrice + (idx1 % 7) * 40);
    const isSale = (idx1 % 4 === 0);
    const isNew  = (!isSale && idx1 % 7 === 0);
    const oldPrice = isSale ? round10(price + 300 + (idx1 % 5) * 50) : null;
    const badge = isSale ? "–ê–ö–¶–ò–à–ê" : (isNew ? "–ù–û–í–û" : "");
    const id = `auto_${catKey(cat)}_${idx1}`;

    return {
      id, name: `MertaX ${cat} #${idx1}`, cat,
      price, oldPrice, badge,
      sizes: sizesByCategory(cat),
      img: demoImg(`${catKey(cat)}-${idx1}`)
    };
  }

  // ===== STORAGE =====
  function loadCustom(){
    try{ const arr = JSON.parse(localStorage.getItem(CUSTOM_KEY) || "[]"); return Array.isArray(arr)?arr:[]; }
    catch(e){ return []; }
  }
  function saveCustom(arr){ localStorage.setItem(CUSTOM_KEY, JSON.stringify(arr)); }

  function loadDeleted(){
    try{ const arr = JSON.parse(localStorage.getItem(DELETED_KEY) || "[]"); return Array.isArray(arr)?arr:[]; }
    catch(e){ return []; }
  }
  function saveDeleted(arr){ localStorage.setItem(DELETED_KEY, JSON.stringify(arr)); }

  function customMap(){
    const map = new Map();
    for(const p of loadCustom()) map.set(p.id, p);
    return map;
  }

  function getCategoryList(cat){
    const del = new Set(loadDeleted());
    const cMap = customMap();
    const list = [];

    // demo products
    for(let i=1;i<=MAX_PER_CATEGORY;i++){
      const dp = demoProduct(cat, i);
      if(del.has(dp.id)) continue;
      const ov = cMap.get(dp.id);
      list.push(ov ? ov : dp);
    }

    // custom non-demo (put first)
    for(const p of cMap.values()){
      if(p.cat !== cat) continue;
      if((p.id || "").startsWith("auto_")) continue;
      if(del.has(p.id)) continue;
      list.unshift(p);
    }

    return list;
  }

  // ===== CART =====
  const loadCart = () => JSON.parse(localStorage.getItem(CART_KEY) || "[]");
  const saveCart = (cart) => localStorage.setItem(CART_KEY, JSON.stringify(cart));

  function findProductById(id){
    const cMap = customMap();
    if(cMap.has(id)) return cMap.get(id);

    if(id.startsWith("auto_")){
      for(const cat of CATEGORIES){
        const prefix = `auto_${catKey(cat)}_`;
        if(id.startsWith(prefix)){
          const idx = Number(id.slice(prefix.length));
          if(Number.isFinite(idx) && idx>=1 && idx<=MAX_PER_CATEGORY){
            return demoProduct(cat, idx);
          }
        }
      }
    }
    return null;
  }

  // ===== UI REFS =====
  const grid = document.getElementById("productGrid");
  const searchInp = document.getElementById("searchInp");
  const catSel = document.getElementById("catSel");
  const sizeFilterSel = document.getElementById("sizeFilterSel");
  const minPriceInp = document.getElementById("minPriceInp");
  const maxPriceInp = document.getElementById("maxPriceInp");
  const sortSel = document.getElementById("sortSel");
  const loadMoreBtn = document.getElementById("loadMoreBtn");
  const infoLine = document.getElementById("infoLine");

  let visibleCount = PAGE_SIZE;

  function currentCategory(){ return (catSel && catSel.value) ? catSel.value : CATEGORIES[0]; }

  function renderCats(){
    if(!catSel) return;
    catSel.innerHTML = CATEGORIES.map(c => `<option value="${c}">${c}</option>`).join("");
  }

  function renderSizeFilter(){
    if(!sizeFilterSel) return;
    const cat = currentCategory();
    const sizes = sizesByCategory(cat);
    sizeFilterSel.innerHTML = [`<option value="ALL">–°–∏—Ç–µ</option>`]
      .concat(sizes.map(s=>`<option value="${s}">${s}</option>`)).join("");
  }

  function numOrNull(v){
    const t = String(v || "").trim();
    if(!t) return null;
    const n = Number(t);
    return Number.isFinite(n) ? n : null;
  }

  function filteredAll(){
    const cat = currentCategory();
    const q = (searchInp?.value || "").trim().toLowerCase();
    const size = (sizeFilterSel?.value || "ALL");
    const minP = numOrNull(minPriceInp?.value);
    const maxP = numOrNull(maxPriceInp?.value);

    let list = getCategoryList(cat);

    if(q) list = list.filter(p => (p.name || "").toLowerCase().includes(q));

    if(size !== "ALL"){
      list = list.filter(p => Array.isArray(p.sizes) && p.sizes.includes(size));
    }

    if(minP !== null) list = list.filter(p => Number(p.price) >= minP);
    if(maxP !== null) list = list.filter(p => Number(p.price) <= maxP);

    // sorting
    const mode = sortSel?.value || "default";
    const scoreBadge = (p, wanted)=> (String(p.badge||"").trim() === wanted) ? 1 : 0;

    if(mode === "price_asc") list.sort((a,b)=>a.price-b.price);
    else if(mode === "price_desc") list.sort((a,b)=>b.price-a.price);
    else if(mode === "new_first") list.sort((a,b)=> scoreBadge(b,"–ù–û–í–û")-scoreBadge(a,"–ù–û–í–û") || a.price-b.price);
    else if(mode === "sale_first") list.sort((a,b)=> scoreBadge(b,"–ê–ö–¶–ò–à–ê")-scoreBadge(a,"–ê–ö–¶–ò–à–ê") || a.price-b.price);
    else if(mode === "name_asc") list.sort((a,b)=> (a.name||"").localeCompare(b.name||""));

    return list;
  }

  function renderProducts(){
    if(!grid) return;

    const list = filteredAll();
    const show = list.slice(0, visibleCount);

    if(infoLine){
      const size = (sizeFilterSel?.value || "ALL");
      const minP = (minPriceInp?.value || "").trim();
      const maxP = (maxPriceInp?.value || "").trim();
      infoLine.textContent =
        `–ö–∞—Ç–µ–≥–æ—Ä–∏—ò–∞: ${currentCategory()} ‚Ä¢ –ü—Ä–∏–∫–∞–∂–∞–Ω–∏: ${show.length} / ${list.length} (–º–∞–∫—Å ${MAX_PER_CATEGORY})` +
        ` ‚Ä¢ –ì–æ–ª–µ–º–∏–Ω–∞: ${size==="ALL"?"–°–∏—Ç–µ":size}` +
        ` ‚Ä¢ –¶–µ–Ω–∞: ${minP||"0"} - ${maxP||"‚àû"}`;
    }

    grid.innerHTML = show.map(p => {
      const old = (p.oldPrice !== null && p.oldPrice !== "" && !isNaN(Number(p.oldPrice))) ? Number(p.oldPrice) : null;
      const badge = (p.badge || "").trim();
      const pct = (old && old > p.price) ? Math.round(((old - p.price)/old)*100) : null;
      const sizes = Array.isArray(p.sizes) && p.sizes.length ? p.sizes : ["UNI"];
      const safeId = (p.id || "").replaceAll('"','');
      const sizeSelId = `size_${safeId}`;

      return `
        <div class="card">
          <div class="imgWrap">
            <img class="img" loading="lazy" src="${p.img}" alt="${p.name}">
            <div class="tagRow">
              ${badge ? `<span class="tag ${badge==="–ù–û–í–û" ? "tag-new" : "tag-sale"}">${badge}</span>` : ""}
              ${pct ? `<span class="tag tag-sale">-${pct}%</span>` : ""}
              ${p.cat ? `<span class="tag">${p.cat}</span>` : ""}
            </div>
          </div>
          <div class="p">
            <p class="name">${p.name}</p>
            <div class="priceLine">
              <span class="priceNow">${p.price} –¥–µ–Ω.</span>
              ${old && old > p.price ? `<span class="priceOld">${old} –¥–µ–Ω.</span>` : ""}
            </div>

            <div class="miniRow">
              <select class="sel miniSel" id="${sizeSelId}">
                ${sizes.map(s => `<option value="${s}">${s}</option>`).join("")}
              </select>
              <button class="btn btn-accent"
                onclick="addToCart('${p.id}', document.getElementById('${sizeSelId}').value)">–î–æ–¥–∞—ò</button>
            </div>

            <div class="small" style="margin-top:8px;">ID: ${p.id}</div>
          </div>
        </div>
      `;
    }).join("");

    if(loadMoreBtn){
      if(visibleCount < list.length){
        loadMoreBtn.style.display = "inline-block";
        const next = Math.min(visibleCount + PAGE_SIZE, list.length);
        loadMoreBtn.textContent = `–í—á–∏—Ç–∞—ò —É—à—Ç–µ (${visibleCount} ‚Üí ${next})`;
      } else {
        loadMoreBtn.style.display = "none";
      }
    }
  }

  function resetPaging(){ visibleCount = PAGE_SIZE; }

  // ===== CART UI =====
  const cartCount = document.getElementById("cartCount");
  const cartTotal = document.getElementById("cartTotal");
  const cartList = document.getElementById("cartList");
  const sumItems = document.getElementById("sumItems");
  const sumTotal = document.getElementById("sumTotal");
  const shipLine = document.getElementById("shipLine");
  const overlay = document.getElementById("overlay");
  const drawer = document.getElementById("drawer");

  const deliverySel = document.getElementById("deliverySel");
  function shippingOn(){ return (deliverySel?.value || "–î–∞") === "–î–∞"; }

  function cartTotals(cart, shippingEnabled){
    let items = 0, subtotal = 0;
    for(const c of cart){
      items += c.qty;
      const p = findProductById(c.id);
      if(p) subtotal += p.price * c.qty;
    }
    const ship = (shippingEnabled && items > 0) ? SHIPPING_FEE : 0;
    return { items, subtotal, ship, total: subtotal + ship };
  }

  function addToCart(id, size){
    const p = findProductById(id);
    const chosenSize = size || (p && p.sizes && p.sizes[0]) || "UNI";
    const key = id + "|" + chosenSize;

    const cart = loadCart();
    const item = cart.find(x => (x.id + "|" + (x.size||"")) === key);
    if(item) item.qty += 1;
    else cart.push({ id, size: chosenSize, qty:1 });
    saveCart(cart);
    renderCartUI();
  }

  function setQty(id, size, qty){
    const cart = loadCart()
      .map(x => (x.id===id && (x.size||"")===size) ? ({...x, qty}) : x)
      .filter(x => x.qty > 0);
    saveCart(cart);
    renderCartUI();
  }

  function clearCart(){ saveCart([]); renderCartUI(); }

  function openCart(){ overlay?.classList.add("show"); drawer?.classList.add("open"); }
  function closeCart(){
    drawer?.classList.remove("open");
    if(!checkoutModal?.classList.contains("show") && !adminModal?.classList.contains("show")) overlay?.classList.remove("show");
  }

  function renderCartUI(){
    const cart = loadCart();
    const { items, ship, total } = cartTotals(cart, shippingOn());

    if(cartCount) cartCount.textContent = items;
    if(cartTotal) cartTotal.textContent = total;
    if(sumItems) sumItems.textContent = items;
    if(sumTotal) sumTotal.textContent = total;
    if(shipLine) shipLine.textContent = ship + " –¥–µ–Ω.";

    if(!cartList) return;
    if(cart.length === 0){
      cartList.innerHTML = `<p class="small">–ö–æ—à–Ω–∏—á–∫–∞—Ç–∞ –µ –ø—Ä–∞–∑–Ω–∞.</p>`;
      return;
    }

    cartList.innerHTML = cart.map(c => {
      const p = findProductById(c.id);
      if(!p) return "";
      const s = c.size || "UNI";
      return `
        <div class="item">
          <img class="thumb" loading="lazy" src="${p.img}" alt="${p.name}">
          <div class="itxt">
            <b>${p.name} <span class="small">(${s})</span></b>
            <div class="small">${p.price} –¥–µ–Ω. √ó ${c.qty} = <b>${p.price*c.qty}</b> –¥–µ–Ω.</div>
            <div class="qty" style="margin-top:8px;">
              <button onclick="setQty('${c.id}','${s}', ${c.qty-1})">‚àí</button>
              <span style="min-width:22px; text-align:center;">${c.qty}</span>
              <button onclick="setQty('${c.id}','${s}', ${c.qty+1})">+</button>
              <button class="btn btn-danger" style="margin-left:auto; padding:8px 10px; border-radius:12px;"
                onclick="setQty('${c.id}','${s}', 0)">–û—Ç—Å—Ç—Ä–∞–Ω–∏</button>
            </div>
          </div>
        </div>
      `;
    }).join("");
  }

  // ===== CHECKOUT =====
  const checkoutModal = document.getElementById("checkoutModal");
  const orderIdText = document.getElementById("orderIdText");
  let currentOrderId = null;

  function makeOrderId(){
    const d = new Date();
    const pad = (n)=> String(n).padStart(2,"0");
    const base = `${d.getFullYear()}${pad(d.getMonth()+1)}${pad(d.getDate())}-${pad(d.getHours())}${pad(d.getMinutes())}${pad(d.getSeconds())}`;
    const rnd = Math.random().toString(16).slice(2,6).toUpperCase();
    return `MX-${base}-${rnd}`;
  }

  function openCheckout(){
    const cart = loadCart();
    if(cart.length === 0){ alert("–ö–æ—à–Ω–∏—á–∫–∞—Ç–∞ –µ –ø—Ä–∞–∑–Ω–∞."); return; }
    currentOrderId = makeOrderId();
    if(orderIdText) orderIdText.textContent = currentOrderId;
    checkoutModal?.classList.add("show");
    overlay?.classList.add("show");
    renderCartUI();
  }

  function closeCheckout(){
    checkoutModal?.classList.remove("show");
    if(!drawer?.classList.contains("open") && !adminModal?.classList.contains("show")) overlay?.classList.remove("show");
  }

  function buildOrderText(){
    const name = (document.getElementById("custName")?.value || "").trim();
    const phone = (document.getElementById("custPhone")?.value || "").trim();
    const note = (document.getElementById("custNote")?.value || "").trim();
    const payment = (document.getElementById("paymentSel")?.value || "–ì–æ—Ç–æ–≤–æ –ø—Ä–∏ –ø—Ä–∏–µ–º").trim();
    const exchange = (document.getElementById("exchangeSel")?.value || "–î–∞").trim();

    const deliveryYes = shippingOn();
    const deliveryAddress = (document.getElementById("deliveryAddress")?.value || "").trim();

    const cart = loadCart();
    const { items, subtotal, ship, total } = cartTotals(cart, deliveryYes);

    let lines = [];
    lines.push("üõçÔ∏è –ù–∞—Ä–∞—á–∫–∞ - MertaX");
    lines.push("üßæ –ë—Ä–æ—ò: " + (currentOrderId || "-"));
    lines.push("");
    lines.push("üë§ –ò–º–µ: " + (name || "-"));
    lines.push("üìû –¢–µ–ª–µ—Ñ–æ–Ω: " + (phone || "-"));
    lines.push("üí≥ –ü–ª–∞—ú–∞—ö–µ: " + payment);
    lines.push("üîÅ –ó–∞–º–µ–Ω–∞: " + exchange);
    lines.push("");

    if(deliveryYes && items>0){
      lines.push("üöö –î–æ—Å—Ç–∞–≤–∞: –î–∞ (+150 –¥–µ–Ω)");
      lines.push("üè† –ê–¥—Ä–µ—Å–∞: " + (deliveryAddress || "-"));
    } else {
      lines.push("üöö –î–æ—Å—Ç–∞–≤–∞: –ù–µ");
      lines.push("üìç –ü–æ–¥–∏–≥–∞—ö–µ: " + STORE_LOCATION);
    }

    if(note){ lines.push(""); lines.push("üìù –ù–∞–ø–æ–º–µ–Ω–∞: " + note); }

    lines.push("");
    lines.push("üì¶ –ü—Ä–æ–∏–∑–≤–æ–¥–∏:");
    cart.forEach(c=>{
      const p = findProductById(c.id);
      if(p){
        const s = c.size || "UNI";
        lines.push(`- ${p.name} (${s}) x${c.qty} = ${p.price*c.qty} –¥–µ–Ω.`);
      }
    });

    lines.push("");
    lines.push(`üß∫ –ü–æ–¥—Å—É–º–∞: ${subtotal} –¥–µ–Ω.`);
    lines.push(`üöö –î–æ—Å—Ç–∞–≤–∞: ${ship} –¥–µ–Ω.`);
    lines.push(`‚úÖ –í–∫—É–ø–Ω–æ –ø—Ä–æ–∏–∑–≤–æ–¥–∏: ${items}`);
    lines.push(`üí∞ –í–∫—É–ø–Ω–æ: ${total} –¥–µ–Ω.`);
    return lines.join("\n");
  }

  function sendToWhatsApp(){
    const url = "https://wa.me/" + WHATSAPP_NUMBER + "?text=" + encodeURIComponent(buildOrderText());
    window.open(url, "_blank");
  }

  // ===== ADMIN =====
  const adminModal = document.getElementById("adminModal");
  const adminLoginBox = document.getElementById("adminLoginBox");
  const adminPanelBox = document.getElementById("adminPanelBox");
  const adminMsg = document.getElementById("adminMsg");

  const pId = document.getElementById("pId");
  const pName = document.getElementById("pName");
  const pCat = document.getElementById("pCat");
  const pPrice = document.getElementById("pPrice");
  const pOldPrice = document.getElementById("pOldPrice");
  const pBadge = document.getElementById("pBadge");
  const pImg = document.getElementById("pImg");
  const pSizes = document.getElementById("pSizes");
  const pImgFile = document.getElementById("pImgFile");
  const pImgCam = document.getElementById("pImgCam");
  const imgPreview = document.getElementById("imgPreview");

  const adminFilterCat = document.getElementById("adminFilterCat");
  const adminSearch = document.getElementById("adminSearch");
  const adminList = document.getElementById("adminList");
  const jsonBox = document.getElementById("jsonBox");

  function getPin(){ return localStorage.getItem(ADMIN_PIN_KEY) || "1234"; }
  function setPin(pin){ localStorage.setItem(ADMIN_PIN_KEY, pin); }

  function toast(msg){
    if(!adminMsg) return;
    adminMsg.textContent = msg;
    setTimeout(()=>{ if(adminMsg.textContent===msg) adminMsg.textContent=""; }, 2500);
  }

  function openAdmin(){
    adminModal?.classList.add("show");
    overlay?.classList.add("show");
    if(adminLoginBox) adminLoginBox.style.display = "block";
    if(adminPanelBox) adminPanelBox.style.display = "none";
    if(adminMsg) adminMsg.textContent = "";
    const pinInp = document.getElementById("adminPinInp");
    if(pinInp) pinInp.value = "";
  }
  function closeAdmin(){
    adminModal?.classList.remove("show");
    if(!drawer?.classList.contains("open") && !checkoutModal?.classList.contains("show")) overlay?.classList.remove("show");
  }

  function fillCatSelects(){
    if(pCat) pCat.innerHTML = CATEGORIES.map(c=>`<option value="${c}">${c}</option>`).join("");
    if(adminFilterCat) adminFilterCat.innerHTML =
      [`<option value="ALL">–°–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</option>`].concat(CATEGORIES.map(c=>`<option value="${c}">${c}</option>`)).join("");
  }

  function parseSizes(str, cat){
    const raw = (str || "").trim();
    if(!raw) return sizesByCategory(cat);
    return raw.split(",").map(x=>x.trim()).filter(Boolean);
  }

  function clearForm(){
    if(pId) pId.value = "";
    if(pName) pName.value = "";
    if(pCat) pCat.value = CATEGORIES[0];
    if(pPrice) pPrice.value = "";
    if(pOldPrice) pOldPrice.value = "";
    if(pBadge) pBadge.value = "";
    if(pImg) pImg.value = "";
    if(pSizes) pSizes.value = sizesByCategory(CATEGORIES[0]).join(",");
    if(imgPreview) imgPreview.style.display = "none";
    if(pImgFile) pImgFile.value = "";
    if(pImgCam) pImgCam.value = "";
  }

  async function fileToCompressedDataURL(file, maxSize=900, quality=0.82){
    const dataURL = await new Promise((resolve, reject) => {
      const r = new FileReader();
      r.onload = () => resolve(r.result);
      r.onerror = reject;
      r.readAsDataURL(file);
    });

    const img = await new Promise((resolve, reject) => {
      const im = new Image();
      im.onload = () => resolve(im);
      im.onerror = reject;
      im.src = dataURL;
    });

    let w = img.width, h = img.height;
    const scale = Math.min(1, maxSize / Math.max(w, h));
    w = Math.round(w * scale);
    h = Math.round(h * scale);

    const canvas = document.createElement("canvas");
    canvas.width = w; canvas.height = h;
    const ctx = canvas.getContext("2d");
    ctx.drawImage(img, 0, 0, w, h);

    return canvas.toDataURL("image/jpeg", quality);
  }

  async function handleFilePick(file){
    if(!file) return;
    try{
      const compressed = await fileToCompressedDataURL(file, 900, 0.82);
      if(pImg) pImg.value = compressed;
      if(imgPreview){ imgPreview.src = compressed; imgPreview.style.display = "block"; }
      toast("–°–ª–∏–∫–∞—Ç–∞ –µ –¥–æ–¥–∞–¥–µ–Ω–∞ ‚úÖ");
    }catch(e){
      alert("–ù–µ —É—Å–ø–µ–∞ upload. –ü—Ä–æ–±–∞—ò –¥—Ä—É–≥–∞ —Å–ª–∏–∫–∞.");
    }
  }

  pImgFile?.addEventListener("change", () => handleFilePick(pImgFile.files && pImgFile.files[0]));
  pImgCam?.addEventListener("change",  () => handleFilePick(pImgCam.files && pImgCam.files[0]));

  function saveProductCustom(){
    const id = (pId?.value || "").trim() || makeId();
    const name = (pName?.value || "").trim();
    const cat = pCat?.value || CATEGORIES[0];
    const price = Number((pPrice?.value || "").trim());
    const oldPriceRaw = (pOldPrice?.value || "").trim();
    const oldPrice = oldPriceRaw ? Number(oldPriceRaw) : null;
    const badge = (pBadge?.value || "").trim();
    const img = (pImg?.value || "").trim() || demoImg(id);
    const sizes = parseSizes(pSizes?.value || "", cat);

    if(!name){ toast("–í–Ω–µ—Å–∏ –∏–º–µ."); return; }
    if(!Number.isFinite(price) || price<=0){ toast("–í–Ω–µ—Å–∏ –≤–∞–ª–∏–¥–Ω–∞ —Ü–µ–Ω–∞."); return; }

    const item = { id, name, cat, price, oldPrice: Number.isFinite(oldPrice)?oldPrice:null, badge, img, sizes };

    // if was deleted, remove from deleted
    const del = loadDeleted().filter(x => x !== id);
    saveDeleted(del);

    const arr = loadCustom();
    const idx = arr.findIndex(x => x.id === id);
    if(idx >= 0) arr[idx] = item;
    else arr.unshift(item);
    saveCustom(arr);

    if(pId) pId.value = id;
    if(imgPreview){ imgPreview.src = img; imgPreview.style.display = "block"; }

    toast(idx>=0 ? "–ê–∂—É—Ä–∏—Ä–∞–Ω–æ ‚úÖ" : "–î–æ–¥–∞–¥–µ–Ω–æ ‚úÖ");
    resetPaging(); renderSizeFilter(); renderProducts(); renderCartUI(); renderAdminList();
  }

  function deleteById(){
    const id = (pId?.value || "").trim();
    if(!id){ toast("–í–Ω–µ—Å–∏ ID –∑–∞ –±—Ä–∏—à–µ—ö–µ."); return; }
    if(!confirm("–°–∏–≥—É—Ä–Ω–æ –¥–∞ —Å–µ –∏–∑–±—Ä–∏—à–µ/—Å–∫—Ä–∏–µ –æ–≤–æ—ò ID?")) return;

    saveCustom(loadCustom().filter(x => x.id !== id));
    const del = new Set(loadDeleted());
    del.add(id);
    saveDeleted([...del]);

    toast("–ò–∑–±—Ä–∏—à–∞–Ω–æ/—Å–∫—Ä–∏–µ–Ω–æ ‚úÖ");
    clearForm();
    resetPaging(); renderSizeFilter(); renderProducts(); renderCartUI(); renderAdminList();
  }

  function clearOverrides(){
    if(!confirm("Reset demo overrides?")) return;
    saveDeleted([]);
    toast("Deleted –ª–∏—Å—Ç–∞ –∏—Å—á–∏—Å—Ç–µ–Ω–∞ ‚úÖ");
    resetPaging(); renderSizeFilter(); renderProducts(); renderCartUI(); renderAdminList();
  }

  function clearAllCustom(){
    if(!confirm("–ò–∑–±—Ä–∏—à–∏ –°–ò–¢–ï custom –ø—Ä–æ–∏–∑–≤–æ–¥–∏?")) return;
    saveCustom([]);
    toast("Custom –∏–∑–±—Ä–∏—à–∞–Ω–∏ ‚úÖ");
    resetPaging(); renderSizeFilter(); renderProducts(); renderCartUI(); renderAdminList();
  }

  function loadToForm(id){
    const p = findProductById(id);
    if(!p){ toast("–ù–µ–º–∞ —Ç–∞–∫–æ–≤ ID."); return; }

    if(pId) pId.value = p.id;
    if(pName) pName.value = p.name || "";
    if(pCat) pCat.value = p.cat || CATEGORIES[0];
    if(pPrice) pPrice.value = p.price || "";
    if(pOldPrice) pOldPrice.value = (p.oldPrice ?? "") === null ? "" : (p.oldPrice ?? "");
    if(pBadge) pBadge.value = p.badge || "";
    if(pImg) pImg.value = p.img || "";
    if(pSizes) pSizes.value = (p.sizes && p.sizes.length) ? p.sizes.join(",") : sizesByCategory(p.cat || CATEGORIES[0]).join(",");

    if(imgPreview && p.img){
      imgPreview.src = p.img;
      imgPreview.style.display = "block";
    } else if(imgPreview){
      imgPreview.style.display = "none";
    }
    toast("–í—á–∏—Ç–∞–Ω–æ ‚úÖ");
  }

  function renderAdminList(){
    if(!adminList) return;
    const q = (adminSearch?.value || "").trim().toLowerCase();
    const f = adminFilterCat?.value || "ALL";
    let list = [];

    for(const cat of CATEGORIES){
      if(f !== "ALL" && cat !== f) continue;
      list = list.concat(getCategoryList(cat));
    }
    if(q){
      list = list.filter(p =>
        (p.name||"").toLowerCase().includes(q) ||
        (p.id||"").toLowerCase().includes(q)
      );
    }
    list = list.slice(0, 200);

    adminList.innerHTML = list.map(p=>{
      return `
        <div class="listRow">
          <div style="min-width:220px;">
            <b>${p.name}</b>
            <div class="small">ID: ${p.id}</div>
          </div>
          <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
            <span class="pill">${p.cat}</span>
            <span class="pill">${p.price} –¥–µ–Ω.</span>
            ${p.badge ? `<span class="pill">${p.badge}</span>` : ""}
          </div>
          <div style="display:flex; gap:8px;">
            <button class="btn btn-ghost" onclick="adminEdit('${p.id}')">Edit</button>
          </div>
        </div>
      `;
    }).join("") || `<div class="small">–ù–µ–º–∞ —Ä–µ–∑—É–ª—Ç–∞—Ç–∏.</div>`;
  }

  async function exportJson(){
    const payload = { custom: loadCustom(), deleted: loadDeleted(), maxPerCategory: MAX_PER_CATEGORY };
    const txt = JSON.stringify(payload, null, 2);
    if(jsonBox) jsonBox.value = txt;
    try{
      await navigator.clipboard.writeText(txt);
      toast("JSON –∫–æ–ø–∏—Ä–∞–Ω ‚úÖ");
    }catch(e){
      toast("Export —Å–ø—Ä–µ–º–µ–Ω (–∫–æ–ø–∏—Ä–∞—ò —Ä–∞—á–Ω–æ).");
    }
  }

  function importJson(){
    try{
      const txt = (jsonBox?.value || "").trim();
      if(!txt){ toast("–ó–∞–ª–µ–ø–∏ JSON –≤–æ –ø–æ–ª–µ—Ç–æ."); return; }
      const obj = JSON.parse(txt);
      if(!obj || typeof obj !== "object"){ toast("–ì—Ä–µ—à–µ–Ω JSON."); return; }

      const custom = Array.isArray(obj.custom) ? obj.custom : [];
      const deleted = Array.isArray(obj.deleted) ? obj.deleted : [];

      const cleaned = custom.map(p=>({
        id: String(p.id || makeId()),
        name: String(p.name || "–ë–µ–∑ –∏–º–µ"),
        cat: CATEGORIES.includes(p.cat) ? p.cat : CATEGORIES[0],
        price: Number(p.price || 0),
        oldPrice: (p.oldPrice===null || p.oldPrice===undefined || p.oldPrice==="") ? null : Number(p.oldPrice),
        badge: (p.badge==="–ù–û–í–û" || p.badge==="–ê–ö–¶–ò–à–ê") ? p.badge : "",
        img: String(p.img || demoImg(p.id||"img")),
        sizes: Array.isArray(p.sizes) && p.sizes.length ? p.sizes : sizesByCategory(CATEGORIES.includes(p.cat)?p.cat:CATEGORIES[0])
      })).filter(p=>p.price>0);

      saveCustom(cleaned);
      saveDeleted(deleted.map(String));

      toast("Import —É—Å–ø–µ—à–µ–Ω ‚úÖ");
      resetPaging(); renderSizeFilter(); renderProducts(); renderCartUI(); renderAdminList();
    }catch(e){
      toast("–ì—Ä–µ—à–∫–∞ –≤–æ JSON.");
    }
  }

  window.adminEdit = loadToForm;

  // ===== EVENTS =====
  const $ = (id)=> document.getElementById(id);

  $("openCartBtn")?.addEventListener("click", openCart);
  $("closeCartBtn")?.addEventListener("click", closeCart);
  $("clearCartBtn")?.addEventListener("click", clearCart);

  $("goCheckoutBtn")?.addEventListener("click", openCheckout);
  $("closeCheckoutBtn")?.addEventListener("click", closeCheckout);
  $("sendWhatsappBtn")?.addEventListener("click", sendToWhatsApp);

  $("adminBtn")?.addEventListener("click", openAdmin);
  $("closeAdminBtn")?.addEventListener("click", closeAdmin);

  overlay?.addEventListener("click", () => { closeCheckout(); closeCart(); closeAdmin(); });

  loadMoreBtn?.addEventListener("click", () => { visibleCount += PAGE_SIZE; renderProducts(); });

  function onFilterChange(){
    resetPaging();
    renderProducts();
    renderCartUI();
  }

  catSel?.addEventListener("change", () => { renderSizeFilter(); onFilterChange(); });
  searchInp?.addEventListener("input", onFilterChange);
  sizeFilterSel?.addEventListener("change", onFilterChange);
  minPriceInp?.addEventListener("input", onFilterChange);
  maxPriceInp?.addEventListener("input", onFilterChange);
  sortSel?.addEventListener("change", onFilterChange);
  deliverySel?.addEventListener("change", renderCartUI);

  // Admin events
  $("adminLoginBtn")?.addEventListener("click", () => {
    const pin = ($("adminPinInp")?.value || "").trim();
    if(pin === getPin()){
      if(adminLoginBox) adminLoginBox.style.display = "block";
      if(adminPanelBox) adminPanelBox.style.display = "block";
      // hide login box
      if(adminLoginBox) adminLoginBox.style.display = "none";
      fillCatSelects();
      clearForm();
      renderAdminList();
      toast("–î–æ–±—Ä–µ–¥–æ—ò–¥–µ ‚úÖ");
    }else{
      alert("–ü–æ–≥—Ä–µ—à–µ–Ω PIN.");
    }
  });

  $("saveProductBtn")?.addEventListener("click", saveProductCustom);
  $("deleteProductBtn")?.addEventListener("click", deleteById);
  $("clearOverridesBtn")?.addEventListener("click", clearOverrides);
  $("clearCustomBtn")?.addEventListener("click", clearAllCustom);

  $("exportBtn")?.addEventListener("click", exportJson);
  $("importBtn")?.addEventListener("click", importJson);

  adminFilterCat?.addEventListener("change", renderAdminList);
  adminSearch?.addEventListener("input", renderAdminList);

  $("changePinBtn")?.addEventListener("click", () => {
    const cur = prompt("–í–Ω–µ—Å–∏ —Ç–µ–∫–æ–≤–µ–Ω PIN:");
    if(cur === null) return;
    if(cur.trim() !== getPin()){ alert("–ü–æ–≥—Ä–µ—à–µ–Ω PIN."); return; }
    const next = prompt("–í–Ω–µ—Å–∏ –Ω–æ–≤ PIN (4+ –∑–Ω–∞—Ü–∏):");
    if(next === null) return;
    if(next.trim().length < 4){ alert("PIN –º–æ—Ä–∞ –¥–∞ –∏–º–∞ –±–∞—Ä–µ–º 4 –∑–Ω–∞—Ü–∏."); return; }
    setPin(next.trim());
    alert("PIN –µ —Å–º–µ–Ω–µ—Ç ‚úÖ");
  });

  // expose cart functions
  window.addToCart = addToCart;
  window.setQty = setQty;

  // ===== SAFE INIT =====
  window.addEventListener("DOMContentLoaded", () => {
    renderCats();
    if(catSel) catSel.value = CATEGORIES[0];
    renderSizeFilter();
    renderProducts();
    renderCartUI();
  });
</script>
</body>
</html>

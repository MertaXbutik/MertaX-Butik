<!doctype html>
<html lang="mk">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MertaX Butik</title>
  <style>
    :root{
      --bg:#070707;
      --card:#101010;
      --card2:#151515;
      --line:rgba(255,255,255,.10);
      --txt:#fff;
      --muted:rgba(255,255,255,.70);
      --muted2:rgba(255,255,255,.55);
      --accent:#22c55e;
      --accent2:rgba(34,197,94,.15);
      --danger:#ef4444;
      --warn:#f59e0b;
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      color:var(--txt);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background:
        radial-gradient(1200px 600px at 20% 10%, rgba(34,197,94,.16), transparent 55%),
        radial-gradient(900px 500px at 80% 20%, rgba(255,255,255,.06), transparent 50%),
        radial-gradient(900px 700px at 50% 100%, rgba(34,197,94,.10), transparent 60%),
        var(--bg);
      min-height:100vh;
    }
    a{ color:inherit; }
    .top{
      position:sticky; top:0; z-index:5;
      backdrop-filter: blur(10px);
      background: rgba(0,0,0,.55);
      border-bottom:1px solid var(--line);
    }
    .top-inner{
      max-width:1100px;
      margin:0 auto;
      padding:12px 14px;
      display:flex;
      gap:12px;
      align-items:center;
      justify-content:space-between;
    }
    .left{ display:flex; gap:12px; align-items:center; min-width:0; flex:1; }
    .hamb{
      width:48px; height:48px;
      border-radius:14px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.04);
      color:var(--txt);
      display:flex; align-items:center; justify-content:center;
      cursor:pointer;
    }
    .brand{ display:flex; gap:12px; align-items:center; min-width:0; cursor:pointer; }
    .logo{
      width:56px; height:56px; border-radius:14px; overflow:hidden;
      border:1px solid rgba(255,255,255,.18);
      background: rgba(255,255,255,.06);
      flex:0 0 56px;
      display:flex; align-items:center; justify-content:center;
    }
    .logo img{ width:100%; height:100%; object-fit:cover; display:block; }
    .btxt{ min-width:0; }
    .btxt .title{
      font-weight:900;
      font-size:26px;
      letter-spacing:.3px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .btxt .sub{
      margin-top:2px;
      color:var(--muted);
      font-size:13px;
      line-height:1.25;
    }

    .actions{ display:flex; gap:10px; align-items:center; }
    .btn{
      border:1px solid var(--line);
      background: rgba(255,255,255,.05);
      color:var(--txt);
      padding:12px 14px;
      border-radius:16px;
      font-weight:800;
      cursor:pointer;
    }
    .btn.primary{
      background: linear-gradient(180deg, rgba(34,197,94,.22), rgba(34,197,94,.10));
      border-color: rgba(34,197,94,.35);
      box-shadow: 0 0 0 1px rgba(34,197,94,.10) inset;
    }

    .wrap{ max-width:1100px; margin:0 auto; padding:16px 14px 40px; }
    .panel{
      border:1px solid var(--line);
      border-radius:22px;
      background: rgba(255,255,255,.03);
      overflow:hidden;
      box-shadow: 0 10px 24px rgba(0,0,0,.30);
    }
    .panel-head{
      padding:18px 18px 14px;
      border-bottom:1px solid var(--line);
      background: rgba(255,255,255,.02);
    }
    .h1{ font-size:34px; font-weight:900; margin:0; }
    .muted{ color:var(--muted); }
    .help{ color:var(--muted2); font-size:12.5px; margin-top:6px; line-height:1.35; }
    .controls{
      padding:14px 18px 18px;
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
    }
    .search{
      flex:1;
      min-width:220px;
      display:flex;
      gap:10px;
      align-items:center;
    }
    input, select, textarea{
      width:100%;
      border-radius:999px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.06);
      color:var(--txt);
      padding:12px 14px;
      outline:none;
    }
    textarea{ border-radius:16px; min-height:86px; resize:vertical; }
    .select{ min-width:220px; }
    .chip{
      border:1px solid var(--line);
      background: rgba(255,255,255,.05);
      padding:9px 12px;
      border-radius:999px;
      color:var(--muted);
      font-size:12.5px;
      max-width:52vw;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .grid{
      padding:14px 18px 22px;
      display:grid;
      grid-template-columns: repeat(2, 1fr);
      gap:12px;
    }
    @media (max-width: 760px){
      .grid{ grid-template-columns: 1fr; }
      .btxt .sub{ display:none; }
      .chip{ display:none; }
      .actions{ gap:8px; }
    }

    .card{
      border:1px solid var(--line);
      background: rgba(255,255,255,.04);
      border-radius:18px;
      overflow:hidden;
      display:flex;
      flex-direction:column;
      min-height:360px;
      box-shadow: 0 10px 24px rgba(0,0,0,.25);
    }
    .imgwrap{
      position:relative;
      aspect-ratio: 16/10;
      background: rgba(255,255,255,.03);
      overflow:hidden;
    }
    .imgwrap img{ width:100%; height:100%; object-fit:cover; display:block; }
    .tag{
      position:absolute;
      left:12px; top:12px;
      background: rgba(0,0,0,.50);
      border:1px solid rgba(255,255,255,.12);
      padding:6px 10px;
      border-radius:999px;
      font-size:12px;
      color:var(--muted);
      backdrop-filter: blur(6px);
    }
    .body{
      padding:14px 14px 12px;
      display:flex;
      flex-direction:column;
      gap:8px;
      flex:1;
    }
    .pname{
      font-size:28px;
      font-weight:900;
      margin:0;
      line-height:1.05;
      letter-spacing:.2px;
    }
    .price{
      font-size:34px;
      font-weight:900;
      color: var(--accent);
      margin-top:2px;
      letter-spacing:.2px;
    }
    .rowline{ display:flex; justify-content:space-between; gap:10px; align-items:center; color:var(--muted); font-size:13px; }
    .sizes{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      margin-top:6px;
    }
    .pill{
      border:1px solid var(--line);
      background: rgba(255,255,255,.04);
      border-radius:999px;
      padding:7px 10px;
      font-size:13px;
      display:flex; gap:8px; align-items:center;
      color:var(--muted);
    }
    .dot{
      width:10px; height:10px; border-radius:50%;
      background: var(--danger);
      box-shadow: 0 0 0 3px rgba(239,68,68,.10);
    }
    .dot.ok{
      background: var(--accent);
      box-shadow: 0 0 0 3px rgba(34,197,94,.12);
    }
    .btnrow{
      display:flex;
      gap:10px;
      padding:12px 14px 14px;
      border-top:1px solid var(--line);
      background: rgba(255,255,255,.02);
    }
    .btnrow .btn{ flex:1; padding:14px 14px; }

    /* Modal */
    .modal{
      position:fixed; inset:0;
      display:none;
      z-index:20;
      background: rgba(0,0,0,.55);
      backdrop-filter: blur(6px);
      padding:18px;
    }
    .modal.show{ display:flex; }
    .modal-card{
      width:min(640px, 100%);
      margin:auto;
      border-radius:22px;
      border:1px solid var(--line);
      background: rgba(10,10,10,.92);
      box-shadow: 0 20px 50px rgba(0,0,0,.55);
      overflow:hidden;
    }
    .modal-head{
      padding:16px 16px 12px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      border-bottom:1px solid var(--line);
    }
    .modal-head h3{ margin:0; font-size:26px; font-weight:900; }
    .modal-body{ padding:14px 16px 18px; }
    .divider{ height:1px; background: var(--line); margin:12px 0; }
    .row{ display:flex; gap:12px; }
    .field{ flex:1; min-width:0; }
    label{ display:block; color:var(--muted); font-size:12.5px; margin:8px 2px 6px; }
    .mini{ font-size:12px; color:var(--muted2); }
    .danger{ color: var(--danger); }
    .ok{ color: var(--accent); }

    /* small fixes */
    .hidden{ display:none !important; }
  </style>
</head>

<body>

  <!-- HEADER -->
  <div class="top">
    <div class="top-inner">
      <div class="left">
        <button class="hamb" id="btnCats" title="–ö–∞—Ç–µ–≥–æ—Ä–∏–∏">
          <svg width="22" height="22" viewBox="0 0 24 24" fill="none">
            <path d="M4 7h16M4 12h16M4 17h16" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          </svg>
        </button>

        <div class="brand" id="brandClick">
          <div class="logo">
            <!-- –õ–æ–≥–æ: –∞–∫–æ IMG_9833.jpeg –Ω–µ –ø–æ—Å—Ç–æ–∏ –≤–æ repo, —ú–µ —Å–µ –ø—Ä–∏–∫–∞–∂–µ fallback -->
            <img
              src="IMG_9833.jpeg"
              alt="MertaX Butik"
              onerror="this.onerror=null;this.src='https://images.unsplash.com/photo-1520975682041-3b3e4a8b1e6a?auto=format&fit=crop&w=600&q=60';"
            />
          </div>
          <div class="btxt">
            <div class="title">MertaX Butik</div>
            <div class="sub">–û–Ω–ª–∞—ò–Ω –Ω–∞—Ä–∞—á–∫–∏ –ø—Ä–µ–∫—É WhatsApp ‚Ä¢ –í–µ–ª–∏—á–∏–Ω–∏ ‚Ä¢ –ó–∞–ª–∏—Ö–∞</div>
          </div>
        </div>
      </div>

      <div class="actions">
        <div class="chip" id="chipCat">–ö–∞—Ç–µ–≥–æ—Ä–∏—ò–∞: (—Å–∏—Ç–µ)</div>
        <button class="btn primary hidden" id="btnAdd">+ –ü—Ä–æ–¥—É–∫—Ç</button>
        <button class="btn" id="btnAdmin">Admin</button>
      </div>
    </div>
  </div>

  <div class="wrap">
    <div class="panel">
      <div class="panel-head">
        <h2 class="h1">–ü—Ä–æ–¥—É–∫—Ç–∏</h2>
        <div class="muted" id="countTxt">0 –ø—Ä–æ–¥—É–∫—Ç–∏</div>
        <div class="help">
          –ö–∞–∫–æ –¥–∞ –Ω–∞—Ä–∞—á–∞—à? 1) –ò–∑–±–µ—Ä–∏ –ø—Ä–æ–¥—É–∫—Ç ‚Üí 2) –ü—Ä–∏—Ç–∏—Å–Ω–∏ ‚Äû–ù–∞—Ä–∞—á–∞—ò‚Äú ‚Üí 3) –ò–∑–±–µ—Ä–∏ –≤–µ–ª–∏—á–∏–Ω–∞ –∏ –∫–æ–ª–∏—á–∏–Ω–∞ ‚Üí 4) –ü–æ—Ç–≤—Ä–¥–∏ ‚Üí
          WhatsApp —ú–µ —Å–µ –æ—Ç–≤–æ—Ä–∏ —Å–æ –≥–æ—Ç–æ–≤–∞ –ø–æ—Ä–∞–∫–∞.
        </div>
      </div>

      <div class="controls">
        <div class="search">
          <input id="q" placeholder="–ü—Ä–µ–±–∞—Ä–∞—ò –ø—Ä–æ–¥—É–∫—Ç..." />
        </div>

        <div class="select">
          <select id="sizeFilter">
            <option value="">–§–∏–ª—Ç–µ—Ä –ø–æ –≤–µ–ª–∏—á–∏–Ω–∞ (—Å–∞–º–æ –¥–æ—Å—Ç–∞–ø–Ω–∏)</option>
          </select>
        </div>

        <button class="btn" id="btnReset">Reset</button>
      </div>

      <div class="grid" id="grid"></div>
    </div>

    <div class="help" style="margin-top:10px;">
      üì± –ù–∞—Ä–∞—á–∫–∞ = WhatsApp –ø–æ—Ä–∞–∫–∞ (–ø—Ä–æ–¥—É–∫—Ç + —Ü–µ–Ω–∞ + –≤–µ–ª–∏—á–∏–Ω–∞ + –∫–æ–ª–∏—á–∏–Ω–∞) <br/>
      üß† –ü–æ–¥–∞—Ç–æ—Ü–∏ –ª–æ–∫–∞–ª–Ω–æ (localStorage) ‚Äî –æ—Å—Ç–∞–Ω—É–≤–∞–∞—Ç –Ω–∞ –∏—Å—Ç–∏–æ—Ç —Ç–µ–ª–µ—Ñ–æ–Ω/PC.
    </div>
  </div>

  <!-- MODAL: Categories -->
  <div class="modal" id="modalCats">
    <div class="modal-card">
      <div class="modal-head">
        <h3>–ö–∞—Ç–µ–≥–æ—Ä–∏–∏</h3>
        <button class="btn" onclick="UI.close('modalCats')">–ó–∞—Ç–≤–æ—Ä–∏</button>
      </div>
      <div class="modal-body" id="catsList"></div>
    </div>
  </div>

  <!-- MODAL: Admin -->
  <div class="modal" id="modalAdmin">
    <div class="modal-card">
      <div class="modal-head">
        <h3>Admin</h3>
        <button class="btn" onclick="UI.close('modalAdmin')">–ó–∞—Ç–≤–æ—Ä–∏</button>
      </div>
      <div class="modal-body">
        <div class="help">
          Admin —Ä–µ–∂–∏–º –µ —Å–∞–º–æ –∑–∞ –¥–æ–¥–∞–≤–∞—ö–µ/–±—Ä–∏—à–µ—ö–µ –ø—Ä–æ–¥—É–∫—Ç–∏. (–ù–∏–∫–æ—ò –¥—Ä—É–≥ –±–µ–∑ –ª–æ–∑–∏–Ω–∫–∞ –Ω–µ–º–∞ –¥–∞ –≥–æ –≥–ª–µ–¥–∞ –∫–æ–ø—á–µ—Ç–æ + –ü—Ä–æ–¥—É–∫—Ç)
        </div>
        <div class="divider"></div>

        <label>–õ–æ–∑–∏–Ω–∫–∞</label>
        <input id="adminPass" type="password" placeholder="–í–Ω–µ—Å–∏ –ª–æ–∑–∏–Ω–∫–∞..." />
        <div class="row" style="margin-top:12px;">
          <button class="btn primary" onclick="loginAdmin()">–ù–∞—ò–∞–≤–∏ —Å–µ</button>
          <button class="btn" onclick="logoutAdmin()">–û–¥—ò–∞–≤–∏</button>
        </div>
        <div class="help" id="adminStatus"></div>
      </div>
    </div>
  </div>

  <!-- MODAL: Add product -->
  <div class="modal" id="modalAdd">
    <div class="modal-card">
      <div class="modal-head">
        <h3>–î–æ–¥–∞—ò –ø—Ä–æ–¥—É–∫—Ç</h3>
        <button class="btn" onclick="UI.close('modalAdd')">–ó–∞—Ç–≤–æ—Ä–∏</button>
      </div>
      <div class="modal-body">
        <div class="row">
          <div class="field">
            <label>–ö–∞—Ç–µ–≥–æ—Ä–∏—ò–∞</label>
            <select id="aCat"></select>
          </div>
          <div class="field">
            <label>–ò–º–µ –Ω–∞ –ø—Ä–æ–¥—É–∫—Ç</label>
            <input id="aName" type="text" placeholder="–ü—Ä–∏–º–µ—Ä: –¢—Ä–µ–Ω–µ—Ä–∫–∏ #1" />
          </div>
        </div>

        <div class="row">
          <div class="field">
            <label>–¶–µ–Ω–∞ (–¥–µ–Ω)</label>
            <input id="aPrice" type="number" inputmode="numeric" placeholder="5590" />
          </div>
          <div class="field">
            <label>–°–ª–∏–∫–∏ (–¥–æ 5 –æ–¥ —Ç–µ–ª–µ—Ñ–æ–Ω)</label>
            <input id="aImgsUpload" type="file" accept="image/*" multiple />
            <div class="help">–ò–∑–±–µ—Ä–∏ –¥–æ 5 —Å–ª–∏–∫–∏ –æ–¥ Gallery/Camera.</div>
          </div>
        </div>

        <div class="row">
          <div class="field">
            <label>–û–ø–∏—Å</label>
            <textarea id="aDesc" placeholder="–ú–∞—Ç–µ—Ä–∏—ò–∞–ª, –¥–µ—Ç–∞–ª–∏, –º–µ—Ä–∫–∏..."></textarea>
          </div>
        </div>

        <div class="divider"></div>

        <label>–ó–∞–ª–∏—Ö–∞ (–æ–±–ª–µ–∫–∞: S‚Äì3XL)</label>
        <input id="aStockClothes" placeholder="S=2,M=5,L=3,XL=1,2XL=0,3XL=0" />
        <div class="help">–ê–∫–æ –µ –∫–∞—Ç–µ–≥–æ—Ä–∏—ò–∞ —Ñ–∞—Ä–º–µ—Ä–∫–∏/–ø–∞–Ω—Ç–∞–ª–æ–Ω–∏, –∫–æ—Ä–∏—Å—Ç–∏ –¥–æ–ª—É.</div>

        <label>–ó–∞–ª–∏—Ö–∞ (—Ñ–∞—Ä–º–µ—Ä–∫–∏/–ø–∞–Ω—Ç–∞–ª–æ–Ω–∏: 30‚Äì42)</label>
        <input id="aStockJeans" placeholder="30=2,31=1,32=0,33=4,34=2,36=1,38=0,40=0,42=0" />

        <div class="divider"></div>
        <button class="btn primary" style="width:100%; padding:16px;" onclick="saveNewProduct()">‚úÖ –ó–∞—á—É–≤–∞—ò –ø—Ä–æ–¥—É–∫—Ç</button>

        <div class="help">
          ‚ö†Ô∏è –°–ª–∏–∫–∏—Ç–µ —Å–µ —á—É–≤–∞–∞—Ç –ª–æ–∫–∞–ª–Ω–æ (–Ω–∞ –∏—Å—Ç–∏–æ—Ç —Ç–µ–ª–µ—Ñ–æ–Ω/PC). –ê–∫–æ —Å—Ç–∞–≤–∞—à –º–Ω–æ–≥—É –≥–æ–ª–µ–º–∏ —Å–ª–∏–∫–∏, –º–æ–∂–µ –¥–∞ —Å–µ –Ω–∞–ø–æ–ª–Ω–∏ –º–µ–º–æ—Ä–∏—ò–∞—Ç–∞.
        </div>
      </div>
    </div>
  </div>

  <!-- MODAL: Details -->
  <div class="modal" id="modalDetails">
    <div class="modal-card">
      <div class="modal-head">
        <h3>–î–µ—Ç–∞–ª–∏</h3>
        <button class="btn" onclick="UI.close('modalDetails')">–ó–∞—Ç–≤–æ—Ä–∏</button>
      </div>
      <div class="modal-body">
        <div class="row" style="gap:12px; align-items:flex-start;">
          <img id="dImg" alt="" style="width:140px; height:105px; object-fit:cover; border-radius:16px; border:1px solid var(--line); background:rgba(255,255,255,.03);" />
          <div style="flex:1; min-width:0;">
            <div id="dTitle" style="font-weight:900; font-size:22px;"></div>
            <div id="dCat" class="muted" style="margin-top:4px;"></div>
            <div id="dPrice" class="ok" style="margin-top:8px; font-weight:900; font-size:22px;"></div>
          </div>
        </div>
        <div class="divider"></div>
        <div id="dDesc" class="muted" style="white-space:pre-wrap; line-height:1.45;"></div>
        <div class="divider"></div>
        <button class="btn danger hidden" id="btnDelete" onclick="deleteProduct()">üóëÔ∏è –ò–∑–±—Ä–∏—à–∏ –ø—Ä–æ–¥—É–∫—Ç (Admin)</button>
      </div>
    </div>
  </div>

  <!-- MODAL: Order -->
  <div class="modal" id="modalOrder">
    <div class="modal-card">
      <div class="modal-head">
        <h3>–ù–∞—Ä–∞—á–∫–∞</h3>
        <button class="btn" onclick="UI.close('modalOrder')">–ó–∞—Ç–≤–æ—Ä–∏</button>
      </div>
      <div class="modal-body">
        <div class="row" style="gap:12px; align-items:flex-start;">
          <img id="oImg" alt="" style="width:140px; height:105px; object-fit:cover; border-radius:16px; border:1px solid var(--line); background:rgba(255,255,255,.03);" />
          <div style="flex:1; min-width:0;">
            <div id="oTitle" style="font-weight:900; font-size:22px;"></div>
            <div id="oCat" class="muted" style="margin-top:4px;"></div>
            <div id="oPrice" class="ok" style="margin-top:8px; font-weight:900; font-size:22px;"></div>
          </div>
        </div>

        <div class="divider"></div>

        <label>–í–µ–ª–∏—á–∏–Ω–∞</label>
        <select id="oSize"></select>
        <div class="help" id="oAvail"></div>

        <label>–ö–æ–ª–∏—á–∏–Ω–∞</label>
        <select id="oQty"></select>
        <div class="help">–å–µ —Å–µ –¥–æ–∑–≤–æ–ª–∏ —Å–∞–º–æ –∫–æ–ª–∏—á–∏–Ω–∞ —à—Ç–æ –µ –Ω–∞ –∑–∞–ª–∏—Ö–∞.</div>

        <div class="divider"></div>
        <button class="btn primary" style="width:100%; padding:16px;" onclick="confirmOrder()">
          ‚úÖ –ü–æ—Ç–≤—Ä–¥–∏ –∏ –æ—Ç–≤–æ—Ä–∏ WhatsApp
        </button>

        <div class="help">
          –ê–∫–æ WhatsApp –Ω–µ —Å–µ –æ—Ç–≤–æ—Ä–∏ –≤–µ–¥–Ω–∞—à –Ω–∞ iPhone: –ø—Ä–æ–±–∞—ò –ø–æ–≤—Ç–æ—Ä–Ω–æ (Safari –ø–æ–Ω–µ–∫–æ–≥–∞—à –±–ª–æ–∫–∏—Ä–∞ popup, –∑–∞—Ç–æ–∞ –∫–æ—Ä–∏—Å—Ç–∏–º–µ –¥–∏—Ä–µ–∫—Ç–µ–Ω redirect).
        </div>
      </div>
    </div>
  </div>

<script>
/* =========================
   CONFIG
========================= */
const WA_PHONE = "38972912601";   // —Ç–≤–æ—ò WhatsApp –±—Ä–æ—ò (–±–µ–∑ +)
const LS_KEY   = "mertax_butik_v4"; // localStorage key

const SIZES_CLOTHES = ["S","M","L","XL","2XL","3XL"];
const SIZES_JEANS   = ["30","31","32","33","34","36","38","40","42"];

const CATS = [
  { id:"cemperi", name:"–è–µ–º–ø–µ—Ä–∏", sizeMode:"clothes" },
  { id:"maicki",  name:"–ú–∞—ò–∏—á–∫–∏", sizeMode:"clothes" },
  { id:"trenerki",name:"–¢—Ä–µ–Ω–µ—Ä–∫–∏", sizeMode:"clothes" }, // 70
  { id:"jakni",   name:"–à–∞–∫–Ω–∏", sizeMode:"clothes" },     // 70
  { id:"odela",   name:"–û–¥e–ª–∞", sizeMode:"clothes" },     // 70
  { id:"bluzoni", name:"–ë–ª—É–∑–æ–Ω–∏", sizeMode:"clothes" },
  { id:"farmerki",name:"–§–∞—Ä–º–µ—Ä–∫–∏/–ü–∞–Ω—Ç–∞–ª–æ–Ω–∏", sizeMode:"jeans" },
  { id:"patiki",  name:"–ü–∞—Ç–∏–∫–∏", sizeMode:"clothes" }
];

/* =========================
   STATE + STORAGE
========================= */
const state = {
  admin:false,
  cat:"",
  q:"",
  size:"",
  products:[],
  selectedId:null,
};

function load(){
  try{
    const raw = localStorage.getItem(LS_KEY);
    if(raw){
      const data = JSON.parse(raw);
      if(Array.isArray(data.products)) state.products = data.products;
    }
  }catch(e){}
  if(!state.products.length){
    state.products = demoProducts();
    save();
  }
}
function save(){
  localStorage.setItem(LS_KEY, JSON.stringify({ products: state.products }));
}

/* =========================
   UI HELPERS
========================= */
const UI = {
  open(id){ document.getElementById(id).classList.add("show"); },
  close(id){ document.getElementById(id).classList.remove("show"); },
  toast(msg){ alert(msg); }
};

function money(n){
  const x = Number(n||0);
  return x.toLocaleString("mk-MK") + " –¥–µ–Ω";
}
function catById(id){ return CATS.find(c=>c.id===id); }

/* ‚úÖ –ï–î–ù–ê fallback —Å–ª–∏–∫–∞ –∑–∞ —Ü–µ–ª —Å–∞—ò—Ç */
const FALLBACK_IMG = "https://images.unsplash.com/photo-1520975682041-3b3e4a8b1e6a?auto=format&fit=crop&w=1200&q=60";

/* ‚úÖ –ë–µ–∑–±–µ–¥–µ–Ω src: –¥–æ–∑–≤–æ–ª–∏ —Å–∞–º–æ data:image –∏–ª–∏ http(s). –°–µ –¥—Ä—É–≥–æ -> FALLBACK */
function safeImg(src){
  src = (src || "").trim();
  if(!src) return FALLBACK_IMG;
  if(src.startsWith("data:image/")) return src;
  if(src.startsWith("http://") || src.startsWith("https://")) return src;
  return FALLBACK_IMG; // "IMG_9833.jpeg", "/path", "file://", –ø—Ä–∞–∑–Ω–æ –∏—Ç–Ω.
}

function pickCover(imgs){
  const first = (imgs && imgs.length) ? imgs[0] : "";
  return safeImg(first);
}

function escapeHtml(s){
  return String(s||"")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}

/* stock parsing: "S=2,M=0" -> {S:2,...} */
function parseStock(str){
  const out = {};
  (str||"").split(",").map(x=>x.trim()).filter(Boolean).forEach(pair=>{
    const [k,v] = pair.split("=").map(x=>x.trim());
    if(!k) return;
    out[k] = Math.max(0, Number(v||0));
  });
  return out;
}
function normalizeStock(mode, stock){
  const sizes = (mode==="jeans") ? SIZES_JEANS : SIZES_CLOTHES;
  const out = {};
  sizes.forEach(s=> out[s] = Math.max(0, Number(stock?.[s]||0)));
  return out;
}
function totalStock(stock){
  return Object.values(stock||{}).reduce((a,b)=>a+Number(b||0),0);
}
function stockRangeText(mode){
  return mode==="jeans" ? "30‚Äì42" : "S‚Äì3XL";
}

/* =========================
   RENDER
========================= */
function buildSizeFilterOptions(){
  const sel = document.getElementById("sizeFilter");
  const prev = sel.value;
  sel.innerHTML = `<option value="">–§–∏–ª—Ç–µ—Ä –ø–æ –≤–µ–ª–∏—á–∏–Ω–∞ (—Å–∞–º–æ –¥–æ—Å—Ç–∞–ø–Ω–∏)</option>`;

  const sizes = new Set();
  const list = filteredProducts(false);
  list.forEach(p=>{
    const c = catById(p.cat);
    const mode = c?.sizeMode || "clothes";
    const st = normalizeStock(mode, p.stock||{});
    Object.entries(st).forEach(([k,v])=>{
      if(v>0) sizes.add(k);
    });
  });

  [...sizes].sort((a,b)=>{
    const aN = Number(a), bN = Number(b);
    if(!isNaN(aN) && !isNaN(bN)) return aN-bN;
    const ca = SIZES_CLOTHES.indexOf(a), cb = SIZES_CLOTHES.indexOf(b);
    return (ca===-1?999:ca)-(cb===-1?999:cb);
  }).forEach(s=>{
    const opt = document.createElement("option");
    opt.value = s;
    opt.textContent = s;
    sel.appendChild(opt);
  });

  sel.value = prev;
}

function filteredProducts(applySize=true){
  let list = [...state.products];

  if(state.cat){
    list = list.filter(p=>p.cat===state.cat);
  }
  if(state.q){
    const q = state.q.toLowerCase();
    list = list.filter(p=> (p.name||"").toLowerCase().includes(q));
  }
  if(applySize && state.size){
    list = list.filter(p=>{
      const c = catById(p.cat);
      const mode = c?.sizeMode || "clothes";
      const st = normalizeStock(mode, p.stock||{});
      return (st[state.size]||0) > 0;
    });
  }

  list.sort((a,b)=>(b.createdAt||0)-(a.createdAt||0));
  return list;
}

function renderCats(){
  const wrap = document.getElementById("catsList");
  wrap.innerHTML = "";

  const allBtn = document.createElement("button");
  allBtn.className = "btn";
  allBtn.style.width = "100%";
  allBtn.style.marginBottom = "10px";
  allBtn.textContent = "–°–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏";
  allBtn.onclick = ()=>{
    state.cat = "";
    UI.close("modalCats");
    renderAll();
  };
  wrap.appendChild(allBtn);

  CATS.forEach(c=>{
    const b = document.createElement("button");
    b.className = "btn";
    b.style.width = "100%";
    b.style.marginBottom = "10px";
    b.textContent = c.name;
    b.onclick = ()=>{
      state.cat = c.id;
      UI.close("modalCats");
      renderAll();
    };
    wrap.appendChild(b);
  });
}

function renderHeaderChip(){
  const chip = document.getElementById("chipCat");
  const c = state.cat ? catById(state.cat)?.name : "(—Å–∏—Ç–µ)";
  chip.textContent = "–ö–∞—Ç–µ–≥–æ—Ä–∏—ò–∞: " + (c || "(—Å–∏—Ç–µ)");
}

function renderGrid(){
  const grid = document.getElementById("grid");
  grid.innerHTML = "";

  const list = filteredProducts(true);
  document.getElementById("countTxt").textContent = `${list.length} –ø—Ä–æ–¥—É–∫—Ç–∏`;

  if(!list.length){
    const empty = document.createElement("div");
    empty.className = "muted";
    empty.style.padding = "18px";
    empty.textContent = "–ù–µ–º–∞ –ø—Ä–æ–¥—É–∫—Ç–∏ –∑–∞ –æ–≤–æ—ò —Ñ–∏–ª—Ç–µ—Ä.";
    grid.appendChild(empty);
    return;
  }

  list.forEach(p=>{
    const c = catById(p.cat);
    const mode = c?.sizeMode || "clothes";
    const stock = normalizeStock(mode, p.stock||{});
    const tot = totalStock(stock);
    const cover = safeImg(pickCover(p.imgs||[]));

    const card = document.createElement("div");
    card.className = "card";
    card.innerHTML = `
      <div class="imgwrap">
        <img
          src="${escapeHtml(cover)}"
          alt=""
          onerror="this.onerror=null;this.src='${escapeHtml(FALLBACK_IMG)}';"
        >
        <div class="tag">${escapeHtml(c?.name || "")}</div>
      </div>

      <div class="body">
        <div class="pname">${escapeHtml(p.name||"")}</div>
        <div class="price">${money(p.price)}</div>

        <div class="rowline">
          <div>–î–æ—Å—Ç–∞–ø–Ω–æ: <b>${tot}</b></div>
          <div>${stockRangeText(mode)}</div>
        </div>

        <div class="sizes">
          ${Object.entries(stock).map(([s,v])=>{
            const ok = v>0;
            return `
              <div class="pill">
                <span class="dot ${ok?'ok':''}"></span>
                <span>${escapeHtml(s)} (${v})</span>
              </div>
            `;
          }).join("")}
        </div>
      </div>

      <div class="btnrow">
        <button class="btn primary" data-act="order">–ù–∞—Ä–∞—á–∞—ò</button>
        <button class="btn" data-act="details">–î–µ—Ç–∞–ª–∏</button>
      </div>
    `;

    card.querySelector('[data-act="order"]').onclick = ()=> openOrder(p.id);
    card.querySelector('[data-act="details"]').onclick = ()=> openDetails(p.id);
    grid.appendChild(card);
  });
}

function renderAdminUI(){
  const btnAdd = document.getElementById("btnAdd");
  if(state.admin) btnAdd.classList.remove("hidden");
  else btnAdd.classList.add("hidden");

  const st = document.getElementById("adminStatus");
  st.innerHTML = state.admin
    ? `<span class="ok">‚úÖ Admin –∞–∫—Ç–∏–≤–µ–Ω</span>`
    : `<span class="muted">Admin –Ω–µ –µ –∞–∫—Ç–∏–≤–µ–Ω.</span>`;
}

function renderAll(){
  renderCats();
  renderHeaderChip();
  buildSizeFilterOptions();
  renderGrid();
  renderAdminUI();
}

/* =========================
   ADMIN
========================= */
function loginAdmin(){
  const pass = document.getElementById("adminPass").value || "";
  const REAL_PASS = "1234"; // —Å–º–µ–Ω–∏ –≤–æ —Å–≤–æ—ò–∞ –ª–æ–∑–∏–Ω–∫–∞

  if(pass === REAL_PASS){
    state.admin = true;
    UI.toast("Admin –∞–∫—Ç–∏–≤–∏—Ä–∞–Ω ‚úÖ");
    document.getElementById("adminPass").value = "";
    renderAll();
    UI.close("modalAdmin");
  }else{
    UI.toast("–ü–æ–≥—Ä–µ—à–Ω–∞ –ª–æ–∑–∏–Ω–∫–∞ ‚ùå");
  }
}
function logoutAdmin(){
  state.admin = false;
  renderAll();
  UI.toast("Admin –∏—Å–∫–ª—É—á–µ–Ω.");
}

/* =========================
   MODALS: Details / Order
========================= */
function openDetails(id){
  const p = state.products.find(x=>x.id===id);
  if(!p) return;
  state.selectedId = id;

  const c = catById(p.cat);
  const img = safeImg(pickCover(p.imgs||[]));

  const dImg = document.getElementById("dImg");
  dImg.src = img;
  dImg.onerror = ()=>{ dImg.onerror=null; dImg.src = FALLBACK_IMG; };

  document.getElementById("dTitle").textContent = p.name || "";
  document.getElementById("dCat").textContent = c?.name || "";
  document.getElementById("dPrice").textContent = money(p.price);
  document.getElementById("dDesc").textContent = p.desc || "–ù–µ–º–∞ –æ–ø–∏—Å.";

  const del = document.getElementById("btnDelete");
  if(state.admin) del.classList.remove("hidden");
  else del.classList.add("hidden");

  UI.open("modalDetails");
}

function deleteProduct(){
  if(!state.admin) return;
  if(!state.selectedId) return;
  if(!confirm("–°–∏–≥—É—Ä–Ω–æ –¥–∞ —Å–µ –∏–∑–±—Ä–∏—à–µ –ø—Ä–æ–¥—É–∫—Ç–æ—Ç?")) return;

  state.products = state.products.filter(p=>p.id!==state.selectedId);
  save();
  renderAll();
  UI.close("modalDetails");
}

function openOrder(id){
  const p = state.products.find(x=>x.id===id);
  if(!p) return;
  state.selectedId = id;

  const c = catById(p.cat);
  const mode = c?.sizeMode || "clothes";
  const stock = normalizeStock(mode, p.stock||{});

  const img = safeImg(pickCover(p.imgs||[]));
  const oImg = document.getElementById("oImg");
  oImg.src = img;
  oImg.onerror = ()=>{ oImg.onerror=null; oImg.src = FALLBACK_IMG; };

  document.getElementById("oTitle").textContent = p.name || "";
  document.getElementById("oCat").textContent = c?.name || "";
  document.getElementById("oPrice").textContent = money(p.price);

  const sel = document.getElementById("oSize");
  sel.innerHTML = "";
  Object.entries(stock).forEach(([s,v])=>{
    const opt = document.createElement("option");
    opt.value = s;
    opt.textContent = `${s} (${v})`;
    if(v<=0) opt.disabled = true;
    sel.appendChild(opt);
  });

  const firstOk = Object.entries(stock).find(([s,v])=>v>0);
  if(firstOk) sel.value = firstOk[0];

  function refreshQty(){
    const size = sel.value;
    const avail = stock[size]||0;
    document.getElementById("oAvail").textContent = `–î–æ—Å—Ç–∞–ø–Ω–æ –∑–∞ ${size}: ${avail}`;

    const q = document.getElementById("oQty");
    q.innerHTML = "";
    const max = Math.max(1, avail);
    for(let i=1;i<=max;i++){
      const opt = document.createElement("option");
      opt.value = String(i);
      opt.textContent = String(i);
      q.appendChild(opt);
    }
    if(avail<=0){
      q.innerHTML = `<option value="0">0</option>`;
    }
  }
  sel.onchange = refreshQty;
  refreshQty();

  UI.open("modalOrder");
}

function buildWhatsAppText(p, size, qty){
  const c = catById(p.cat);
  return [
    "–ù–∞—Ä–∞—á–∫–∞ - MertaX Butik",
    `–ü—Ä–æ–¥—É–∫—Ç: ${p.name}`,
    `–ö–∞—Ç–µ–≥–æ—Ä–∏—ò–∞: ${c?.name || ""}`,
    `–¶–µ–Ω–∞: ${money(p.price)}`,
    `–í–µ–ª–∏—á–∏–Ω–∞: ${size}`,
    `–ö–æ–ª–∏—á–∏–Ω–∞: ${qty}`,
  ].join("\n");
}

function confirmOrder(){
  const p = state.products.find(x=>x.id===state.selectedId);
  if(!p) return;

  const c = catById(p.cat);
  const mode = c?.sizeMode || "clothes";
  const stock = normalizeStock(mode, p.stock||{});

  const size = document.getElementById("oSize").value;
  const qty = Number(document.getElementById("oQty").value || 0);

  if(!size || qty<=0){
    UI.toast("–ò–∑–±–µ—Ä–∏ –≤–µ–ª–∏—á–∏–Ω–∞ –∏ –∫–æ–ª–∏—á–∏–Ω–∞.");
    return;
  }
  const avail = stock[size]||0;
  if(qty > avail){
    UI.toast("–ù–µ–º–∞ –¥–æ–≤–æ–ª–Ω–æ –∑–∞–ª–∏—Ö–∞ –∑–∞ –∏–∑–±—Ä–∞–Ω–∞—Ç–∞ –≤–µ–ª–∏—á–∏–Ω–∞.");
    return;
  }

  stock[size] = avail - qty;
  p.stock = stock;

  save();
  renderAll();
  UI.close("modalOrder");

  const text = buildWhatsAppText(p, size, qty);
  const url  = `https://wa.me/${WA_PHONE}?text=${encodeURIComponent(text)}`;
  window.location.href = url;
}

/* =========================
   ADD PRODUCT (PHONE IMAGES)
========================= */
function uid(){
  return Math.random().toString(16).slice(2) + Date.now().toString(16);
}
function readFileAsDataURL(file){
  return new Promise((resolve,reject)=>{
    const r = new FileReader();
    r.onload = ()=> resolve(r.result);
    r.onerror = reject;
    r.readAsDataURL(file);
  });
}

function openAddModal(){
  if(!state.admin){
    UI.toast("–°–∞–º–æ Admin –º–æ–∂–µ –¥–∞ –¥–æ–¥–∞–≤–∞ –ø—Ä–æ–¥—É–∫—Ç–∏.");
    return;
  }

  const aCat = document.getElementById("aCat");
  aCat.innerHTML = "";
  CATS.forEach(c=>{
    const opt = document.createElement("option");
    opt.value = c.id;
    opt.textContent = c.name;
    aCat.appendChild(opt);
  });

  document.getElementById("aName").value = "";
  document.getElementById("aPrice").value = "";
  document.getElementById("aDesc").value = "";
  document.getElementById("aStockClothes").value = "";
  document.getElementById("aStockJeans").value = "";
  document.getElementById("aImgsUpload").value = "";

  UI.open("modalAdd");
}

async function saveNewProduct(){
  if(!state.admin) return;

  const cat = document.getElementById("aCat").value;
  const name = (document.getElementById("aName").value||"").trim();
  const price = Number(document.getElementById("aPrice").value || 0);
  const desc = (document.getElementById("aDesc").value||"").trim();

  if(!cat || !name || price<=0){
    UI.toast("–í–Ω–µ—Å–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏—ò–∞, –∏–º–µ –∏ —Ü–µ–Ω–∞.");
    return;
  }

  const c = catById(cat);
  const mode = c?.sizeMode || "clothes";

  const fileInput = document.getElementById("aImgsUpload");
  const files = Array.from(fileInput?.files || []).slice(0,5);

  let imgs = [];
  if(files.length){
    try{
      imgs = await Promise.all(files.map(readFileAsDataURL));
      imgs = imgs.map(safeImg); // ‚úÖ —Å–∞–º–æ data:image —ú–µ –ø–æ–º–∏–Ω–µ, –¥—Ä—É–≥–æ -> fallback
    }catch(e){
      UI.toast("–ü—Ä–æ–±–ª–µ–º —Å–æ —á–∏—Ç–∞—ö–µ –Ω–∞ —Å–ª–∏–∫–∏—Ç–µ. –ü—Ä–æ–±–∞—ò –ø–æ–≤—Ç–æ—Ä–Ω–æ.");
      return;
    }
  }else{
    imgs = [FALLBACK_IMG];
  }

  const stockC = parseStock(document.getElementById("aStockClothes").value);
  const stockJ = parseStock(document.getElementById("aStockJeans").value);

  const stock = (mode==="jeans")
    ? normalizeStock("jeans", stockJ)
    : normalizeStock("clothes", stockC);

  const p = {
    id: uid(),
    cat,
    name,
    price,
    desc,
    imgs,
    stock,
    createdAt: Date.now()
  };

  state.products.unshift(p);
  save();
  renderAll();
  UI.close("modalAdd");

  if(fileInput) fileInput.value = "";
  UI.toast("–ü—Ä–æ–¥—É–∫—Ç–æ—Ç –µ –∑–∞—á—É–≤–∞–Ω ‚úÖ");
}

/* =========================
   DEMO DATA
========================= */
function demoProducts(){
  const out = [];
  const now = Date.now();

  function mkStock(mode){
    if(mode==="jeans"){
      return normalizeStock("jeans", {30:2,31:1,32:0,33:3,34:2,36:1,38:0,40:0,42:0});
    }
    return normalizeStock("clothes", {S:0,M:1,L:6,XL:0,"2XL":1,"3XL":3});
  }

  CATS.forEach((c,idx)=>{
    for(let i=1;i<=6;i++){
      out.push({
        id: uid(),
        cat: c.id,
        name: `${c.name} #${i}`,
        price: 1200 + (idx*400) + i*15,
        desc: "–î–µ–º–æ –æ–ø–∏—Å. (–û–≤–∞ –º–æ–∂–µ—à –¥–∞ –≥–æ —Å–º–µ–Ω–∏—à/–∏–∑–±—Ä–∏—à–µ—à.)",
        imgs: [FALLBACK_IMG],
        stock: mkStock(c.sizeMode),
        createdAt: now - (idx*100000 + i*1000)
      });
    }
  });

  return out;
}

/* =========================
   INIT + EVENTS
========================= */
function init(){
  load();

  document.getElementById("btnCats").onclick = ()=> UI.open("modalCats");
  document.getElementById("brandClick").onclick = ()=> { state.cat=""; renderAll(); };

  document.getElementById("btnAdmin").onclick = ()=> UI.open("modalAdmin");
  document.getElementById("btnAdd").onclick = ()=> openAddModal();

  document.getElementById("q").oninput = (e)=>{ state.q = e.target.value || ""; renderAll(); };
  document.getElementById("sizeFilter").onchange = (e)=>{ state.size = e.target.value || ""; renderGrid(); };
  document.getElementById("btnReset").onclick = ()=>{
    state.q=""; state.size=""; state.cat="";
    document.getElementById("q").value="";
    document.getElementById("sizeFilter").value="";
    renderAll();
  };

  ["modalCats","modalAdmin","modalAdd","modalDetails","modalOrder"].forEach(id=>{
    const m = document.getElementById(id);
    m.addEventListener("click", (e)=>{ if(e.target===m) UI.close(id); });
  });

  renderAll();
}
init();
</script>

</body>
</html>

<!doctype html>
<html lang="mk">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>MertaX Butik</title>
  <meta name="color-scheme" content="light dark">
  <style>
    :root{
      --bg:#0b0f14;
      --card:#0f1621;
      --card2:#101b28;
      --txt:#eef2ff;
      --muted:#9aa6b2;
      --line:rgba(255,255,255,.08);
      --accent:#22c55e;
      --accent2:#60a5fa;
      --danger:#ef4444;
      --warn:#f59e0b;
      --shadow: 0 18px 45px rgba(0,0,0,.35);
      --radius:16px;
      --radius2:22px;
      --max:1200px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial;
      background: radial-gradient(1200px 600px at 20% 0%, rgba(96,165,250,.18), transparent 55%),
                  radial-gradient(900px 500px at 90% 10%, rgba(34,197,94,.16), transparent 55%),
                  linear-gradient(180deg, #071019, #05070a);
      color:var(--txt);
      min-height:100vh;
    }
    a{color:inherit}
    .wrap{max-width:var(--max); margin:0 auto; padding:18px 14px 80px}
    /* Top bar */
    .topbar{
      position:sticky; top:0; z-index:40;
      backdrop-filter: blur(12px);
      background: rgba(5,7,10,.72);
      border-bottom: 1px solid var(--line);
    }
    .topbar-inner{max-width:var(--max); margin:0 auto; padding:12px 14px; display:flex; gap:12px; align-items:center; justify-content:space-between;}
    .brand{display:flex; gap:12px; align-items:center;}
    .logo{
      width:44px; height:44px; border-radius:14px;
      background: linear-gradient(135deg, rgba(34,197,94,.95), rgba(96,165,250,.9));
      box-shadow: 0 10px 26px rgba(34,197,94,.18);
      display:grid; place-items:center;
      position:relative;
      overflow:hidden;
    }
    .logo:before{
      content:"";
      position:absolute; inset:-20px;
      background: radial-gradient(circle at 30% 30%, rgba(255,255,255,.38), transparent 45%);
      transform: rotate(18deg);
    }
    .hanger{
      width:22px; height:22px;
      border:2px solid rgba(255,255,255,.92);
      border-bottom:0;
      border-radius: 10px 10px 0 0;
      position:relative;
      transform: translateY(2px);
    }
    .hanger:before{
      content:"";
      position:absolute;
      left:50%; top:-9px;
      width:10px; height:10px;
      border:2px solid rgba(255,255,255,.92);
      border-bottom:0; border-left:0;
      border-radius: 0 10px 0 0;
      transform: translateX(-50%) rotate(45deg);
    }
    .brand h1{margin:0; font-size:16px; letter-spacing:.8px}
    .brand p{margin:2px 0 0; color:var(--muted); font-size:12px}
    .right-actions{display:flex; gap:8px; align-items:center; flex-wrap:wrap; justify-content:flex-end;}
    .chip{
      display:inline-flex; gap:8px; align-items:center;
      padding:9px 11px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.04);
      border-radius:999px;
      font-size:12px;
      color:var(--muted);
    }
    .btn{
      appearance:none; border:0; cursor:pointer;
      padding:10px 12px;
      border-radius:12px;
      background: rgba(255,255,255,.06);
      border:1px solid var(--line);
      color:var(--txt);
      font-weight:600;
      transition:.15s transform, .15s background, .15s border;
    }
    .btn:hover{transform: translateY(-1px); background: rgba(255,255,255,.09);}
    .btn.primary{background: linear-gradient(135deg, rgba(34,197,94,.95), rgba(34,197,94,.65)); border-color: rgba(34,197,94,.55);}
    .btn.blue{background: linear-gradient(135deg, rgba(96,165,250,.92), rgba(96,165,250,.62)); border-color: rgba(96,165,250,.55);}
    .btn.danger{background: rgba(239,68,68,.18); border-color: rgba(239,68,68,.45); color:#ffd6d6;}
    .btn.ghost{background: transparent;}
    /* Layout */
    .grid{
      display:grid;
      grid-template-columns: 330px 1fr;
      gap:16px;
      margin-top:16px;
    }
    @media (max-width: 980px){
      .grid{grid-template-columns:1fr}
    }
    .panel{
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border:1px solid var(--line);
      border-radius: var(--radius2);
      box-shadow: var(--shadow);
    }
    .panel .head{padding:14px 14px 10px; border-bottom:1px solid var(--line); display:flex; align-items:center; justify-content:space-between; gap:10px;}
    .panel .head h2{margin:0; font-size:14px; letter-spacing:.6px}
    .panel .body{padding:12px 14px}
    .search{
      display:flex; gap:10px; align-items:center;
      background: rgba(0,0,0,.25);
      border:1px solid var(--line);
      border-radius: 14px;
      padding:10px 12px;
    }
    .search input{
      width:100%; border:0; outline:0;
      background: transparent; color:var(--txt);
      font-size:14px;
    }
    .search span{color:var(--muted); font-size:12px}
    .cats{display:flex; flex-direction:column; gap:8px; margin-top:12px;}
    .cat{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      padding:10px 12px;
      border-radius: 14px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.03);
      cursor:pointer;
      transition:.12s background, .12s transform, .12s border;
    }
    .cat:hover{transform: translateY(-1px); background: rgba(255,255,255,.06);}
    .cat.active{border-color: rgba(34,197,94,.55); background: rgba(34,197,94,.08);}
    .cat .name{font-weight:700; font-size:13px}
    .cat .count{font-size:12px; color:var(--muted)}
    /* Products */
    .products-head{
      display:flex; gap:10px; align-items:center; justify-content:space-between; flex-wrap:wrap;
      padding:14px 14px 10px;
      border-bottom: 1px solid var(--line);
    }
    .filters{
      display:flex; gap:10px; align-items:center; flex-wrap:wrap;
    }
    .select, .input{
      background: rgba(0,0,0,.25);
      border:1px solid var(--line);
      color:var(--txt);
      border-radius: 12px;
      padding:10px 12px;
      outline:0;
      font-size:13px;
    }
    .cards{
      padding:14px;
      display:grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap:12px;
    }
    @media (max-width: 980px){ .cards{grid-template-columns: repeat(2, minmax(0,1fr));} }
    @media (max-width: 520px){ .cards{grid-template-columns: 1fr;} }
    .card{
      border-radius: var(--radius2);
      border:1px solid var(--line);
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      overflow:hidden;
      box-shadow: 0 16px 40px rgba(0,0,0,.25);
      display:flex; flex-direction:column;
      min-height: 340px;
    }
    .img{
      height: 180px;
      background: rgba(0,0,0,.25);
      border-bottom:1px solid var(--line);
      position:relative;
    }
    .img img{
      width:100%; height:100%; object-fit:cover; display:block;
    }
    .badge{
      position:absolute; left:10px; top:10px;
      padding:6px 10px;
      border-radius: 999px;
      font-size:12px;
      background: rgba(0,0,0,.55);
      border:1px solid rgba(255,255,255,.12);
      color: #e5e7eb;
    }
    .soldout{
      background: rgba(239,68,68,.3);
      border-color: rgba(239,68,68,.55);
      color:#ffe1e1;
    }
    .card .content{padding:12px 12px 12px; display:flex; flex-direction:column; gap:10px; flex:1;}
    .title{font-weight:800; letter-spacing:.2px}
    .meta{display:flex; align-items:center; justify-content:space-between; gap:10px}
    .price{font-weight:900}
    .muted{color:var(--muted); font-size:12px}
    .sizes{display:flex; gap:6px; flex-wrap:wrap}
    .size{
      padding:6px 8px;
      border-radius: 12px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.03);
      font-size:12px;
      display:flex; gap:6px; align-items:center;
    }
    .dot{
      width:8px; height:8px; border-radius:999px;
      background: var(--accent);
      box-shadow: 0 0 0 3px rgba(34,197,94,.12);
    }
    .dot.zero{background: var(--danger); box-shadow: 0 0 0 3px rgba(239,68,68,.12);}
    .actions{display:flex; gap:8px; margin-top:auto}
    .actions .btn{flex:1; padding:10px 10px; border-radius:14px; font-size:13px;}
    /* Modal */
    .modal{
      position:fixed; inset:0; z-index:60;
      display:none;
      background: rgba(0,0,0,.55);
      backdrop-filter: blur(8px);
      padding:16px;
      overflow:auto;
    }
    .modal.show{display:block}
    .modal-card{
      max-width: 900px;
      margin: 20px auto;
      border-radius: 20px;
      border:1px solid var(--line);
      background: linear-gradient(180deg, rgba(15,22,33,.98), rgba(8,12,18,.96));
      box-shadow: 0 26px 70px rgba(0,0,0,.55);
      overflow:hidden;
    }
    .modal-head{
      padding:14px 14px;
      border-bottom:1px solid var(--line);
      display:flex; gap:10px; align-items:center; justify-content:space-between; flex-wrap:wrap;
    }
    .modal-head h3{margin:0; font-size:14px; letter-spacing:.6px}
    .modal-body{padding:14px}
    .form{
      display:grid; grid-template-columns: 1fr 1fr;
      gap:12px;
    }
    @media (max-width: 760px){ .form{grid-template-columns:1fr;} }
    label{display:block; font-size:12px; color:var(--muted); margin:0 0 6px}
    .field input, .field textarea, .field select{
      width:100%;
      background: rgba(0,0,0,.25);
      border:1px solid var(--line);
      color:var(--txt);
      border-radius: 12px;
      padding:10px 12px;
      outline:0;
      font-size:14px;
    }
    .field textarea{min-height:92px; resize:vertical}
    .help{font-size:12px; color:var(--muted); margin-top:6px}
    .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
    .row .btn{padding:10px 12px}
    .divider{height:1px; background: var(--line); margin:12px 0}
    .footerbar{
      position:fixed; left:0; right:0; bottom:0; z-index:45;
      background: rgba(5,7,10,.78);
      backdrop-filter: blur(10px);
      border-top:1px solid var(--line);
    }
    .footerbar .inner{
      max-width:var(--max);
      margin:0 auto;
      padding:10px 14px;
      display:flex; gap:10px; align-items:center; justify-content:space-between; flex-wrap:wrap;
      color:var(--muted);
      font-size:12px;
    }
    .pill{padding:6px 10px; border-radius:999px; border:1px solid var(--line); background: rgba(255,255,255,.03); color:var(--muted);}
    .hint{color:var(--muted); font-size:12px}
    .k{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;}
  </style>
</head>
<body>

  <div class="topbar">
    <div class="topbar-inner">
      <div class="brand">
        <div class="logo" aria-label="MertaX Logo"><div class="hanger"></div></div>
        <div>
          <h1>MertaX Butik</h1>
          <p>–û–Ω–ª–∞—ò–Ω –Ω–∞—Ä–∞—á–∫–∏ –ø—Ä–µ–∫—É WhatsApp ‚Ä¢ –í–µ–ª–∏—á–∏–Ω–∏ ‚Ä¢ –ó–∞–ª–∏—Ö–∞</p>
        </div>
      </div>

      <div class="right-actions">
        <span class="chip" id="chipCat">–ö–∞—Ç–µ–≥–æ—Ä–∏—ò–∞: <b id="chipCatName">‚Äî</b></span>
        <button class="btn ghost" id="btnAdmin">Admin</button>
      </div>
    </div>
  </div>

  <div class="wrap">
    <div class="grid">
      <!-- LEFT: categories -->
      <div class="panel">
        <div class="head">
          <h2>–ö–∞—Ç–µ–≥–æ—Ä–∏–∏</h2>
          <button class="btn blue" id="btnNewCat" title="–î–æ–¥–∞—ò –∫–∞—Ç–µ–≥–æ—Ä–∏—ò–∞ (Admin)">+ –ö–∞—Ç–µ–≥–æ—Ä–∏—ò–∞</button>
        </div>
        <div class="body">
          <div class="search">
            <span>üîé</span>
            <input id="catSearch" placeholder="–ü—Ä–µ–±–∞—Ä–∞—ò –∫–∞—Ç–µ–≥–æ—Ä–∏—ò–∞..." />
          </div>
          <div class="cats" id="cats"></div>
          <div class="hint" style="margin-top:10px;">
            * –î–æ–¥–∞–≤–∞—ö–µ/–±—Ä–∏—à–µ—ö–µ/–ø—Ä–æ–º–µ–Ω–∞ –Ω–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ —Ä–∞–±–æ—Ç–∏ —Å–∞–º–æ –∫–æ–≥–∞ —Å–∏ –ª–æ–≥–∏—Ä–∞–Ω–∞ –∫–∞–∫–æ Admin.
          </div>
        </div>
      </div>

      <!-- RIGHT: products -->
      <div class="panel">
        <div class="products-head">
          <div style="display:flex; flex-direction:column; gap:4px;">
            <div style="font-weight:800; letter-spacing:.3px;">–ü—Ä–æ–¥—É–∫—Ç–∏</div>
            <div class="muted" id="prodInfo">0 –ø—Ä–æ–¥—É–∫—Ç–∏</div>
          </div>

          <div class="filters">
            <input class="input" id="prodSearch" placeholder="–ü—Ä–µ–±–∞—Ä–∞—ò –ø—Ä–æ–¥—É–∫—Ç..." />
            <select class="select" id="sizeFilter">
              <option value="">–§–∏–ª—Ç–µ—Ä –ø–æ –≤–µ–ª–∏—á–∏–Ω–∞ (—Å–∞–º–æ –¥–æ—Å—Ç–∞–ø–Ω–∏)</option>
            </select>
            <button class="btn primary" id="btnNewProd">+ –ü—Ä–æ–¥—É–∫—Ç</button>
          </div>
        </div>

        <div class="cards" id="cards"></div>
      </div>
    </div>
  </div>

  <div class="footerbar">
    <div class="inner">
      <div class="pill">üì≤ –ù–∞—Ä–∞—á–∫–∞ = WhatsApp –ø–æ—Ä–∞–∫–∞ —Å–æ: –ø—Ä–æ–¥—É–∫—Ç + —Ü–µ–Ω–∞ + –≤–µ–ª–∏—á–∏–Ω–∞</div>
      <div class="pill">üß† –°–µ —á—É–≤–∞ –ª–æ–∫–∞–ª–Ω–æ (localStorage)</div>
    </div>
  </div>

  <!-- MODAL: Admin login -->
  <div class="modal" id="modalAdmin">
    <div class="modal-card">
      <div class="modal-head">
        <h3>Admin –ø—Ä–∏—Å—Ç–∞–ø</h3>
        <button class="btn" onclick="UI.close('modalAdmin')">–ó–∞—Ç–≤–æ—Ä–∏</button>
      </div>
      <div class="modal-body">
        <div class="field" style="max-width:520px;">
          <label>Admin –ª–æ–∑–∏–Ω–∫–∞</label>
          <input id="adminPass" type="password" placeholder="–í–Ω–µ—Å–∏ –ª–æ–∑–∏–Ω–∫–∞..." />
          <div class="help">
            * –õ–æ–∑–∏–Ω–∫–∞—Ç–∞ —Å–µ —á—É–≤–∞ –ª–æ–∫–∞–ª–Ω–æ. –ú–æ–∂–µ –¥–∞ —ò–∞ —Å–º–µ–Ω–∏—à –ø–æ –ª–æ–≥–∏—Ä–∞—ö–µ.
          </div>
        </div>

        <div class="row" style="margin-top:12px;">
          <button class="btn primary" id="btnLogin">–õ–æ–≥–∏—Ä–∞—ò</button>
          <button class="btn danger" id="btnLogout" style="display:none;">–û–¥—ò–∞–≤–∞</button>
          <span class="chip">–°—Ç–∞—Ç—É—Å: <b id="adminStatus">–ù–µ-–∞–¥–º–∏–Ω</b></span>
        </div>

        <div class="divider"></div>

        <div id="adminTools" style="display:none;">
          <div class="field" style="max-width:520px;">
            <label>–°–º–µ–Ω–∏ Admin –ª–æ–∑–∏–Ω–∫–∞</label>
            <input id="newAdminPass" type="password" placeholder="–ù–æ–≤–∞ –ª–æ–∑–∏–Ω–∫–∞..." />
            <div class="row" style="margin-top:10px;">
              <button class="btn blue" id="btnChangePass">–ó–∞—á—É–≤–∞—ò –ª–æ–∑–∏–Ω–∫–∞</button>
              <span class="muted">–°–æ–≤–µ—Ç: –∑–∞–ø–æ–º–Ω–∏ —ò–∞ üôÇ</span>
            </div>
          </div>

          <div class="divider"></div>

          <div class="row">
            <button class="btn blue" id="btnManageCats">–ú–µ–Ω–∞—ü–∏—Ä–∞—ò –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</button>
          </div>
          <div class="help">* ‚Äú–ú–µ–Ω–∞—ü–∏—Ä–∞—ò –∫–∞—Ç–µ–≥–æ—Ä–∏–∏‚Äù –æ—Ç–≤–æ—Ä–∞ –ª–∏—Å—Ç–∞ –∑–∞ rename/delete.</div>
        </div>
      </div>
    </div>
  </div>

  <!-- MODAL: Manage categories -->
  <div class="modal" id="modalCats">
    <div class="modal-card">
      <div class="modal-head">
        <h3>–ö–∞—Ç–µ–≥–æ—Ä–∏–∏ (Admin)</h3>
        <button class="btn" onclick="UI.close('modalCats')">–ó–∞—Ç–≤–æ—Ä–∏</button>
      </div>
      <div class="modal-body">
        <div class="field" style="max-width:520px;">
          <label>–ù–æ–≤–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏—ò–∞</label>
          <input id="newCatName" placeholder="–ü—Ä–∏–º–µ—Ä: –ñ–µ–Ω—Å–∫–∏ / –ú–∞—à–∫–∏ / –û–±—É–≤–∫–∏..." />
          <div class="row" style="margin-top:10px;">
            <button class="btn primary" id="btnAddCat2">–î–æ–¥–∞—ò</button>
          </div>
        </div>

        <div class="divider"></div>

        <div id="catAdminList"></div>
      </div>
    </div>
  </div>

  <!-- MODAL: Product editor -->
  <div class="modal" id="modalProd">
    <div class="modal-card">
      <div class="modal-head">
        <h3 id="prodModalTitle">–ü—Ä–æ–¥—É–∫—Ç</h3>
        <div class="row">
          <button class="btn danger" id="btnDeleteProd" style="display:none;">–ò–∑–±—Ä–∏—à–∏</button>
          <button class="btn" onclick="UI.close('modalProd')">–ó–∞—Ç–≤–æ—Ä–∏</button>
        </div>
      </div>
      <div class="modal-body">
        <div class="form">
          <div class="field">
            <label>–ò–º–µ</label>
            <input id="pName" placeholder="–ü—Ä–∏–º–µ—Ä: –¢—Ä–µ–Ω–µ—Ä–∫–∞ Nike..." />
          </div>
          <div class="field">
            <label>–¶–µ–Ω–∞ (–¥–µ–Ω)</label>
            <input id="pPrice" type="number" min="0" step="1" placeholder="1990" />
          </div>

          <div class="field">
            <label>–ö–∞—Ç–µ–≥–æ—Ä–∏—ò–∞</label>
            <select id="pCat"></select>
          </div>

          <div class="field">
            <label>WhatsApp –±—Ä–æ—ò (—Å–æ –∫–æ–¥)</label>
            <input id="pWa" placeholder="–ü—Ä–∏–º–µ—Ä: 38970123456" />
            <div class="help">–ë–µ–∑ + –∏ –±–µ–∑ –ø—Ä–∞–∑–Ω–æ –º–µ—Å—Ç–æ. (–ü—Ä–∏–º–µ—Ä: 38970xxxxxx)</div>
          </div>

          <div class="field" style="grid-column:1/-1;">
            <label>–°–ª–∏–∫–∏ (3‚Äì5) ‚Äî –ª–∏–Ω–∫–æ–≤–∏ –æ–¥–¥–µ–ª–µ–Ω–∏ —Å–æ –Ω–æ–≤ —Ä–µ–¥</label>
            <textarea id="pImages" placeholder="https://...jpg&#10;https://...jpg"></textarea>
            <div class="help">–ê–∫–æ –Ω–µ–º–∞—à –ª–∏–Ω–∫, –æ—Å—Ç–∞–≤–∏ –ø—Ä–∞–∑–Ω–æ ‚Äî —ú–µ –∏–º–∞ placeholder.</div>
          </div>

          <div class="field" style="grid-column:1/-1;">
            <label>–û–ø–∏—Å</label>
            <textarea id="pDesc" placeholder="–ö—Ä–∞—Ç–æ–∫ –æ–ø–∏—Å..."></textarea>
          </div>

          <div class="field" style="grid-column:1/-1;">
            <label>–ó–∞–ª–∏—Ö–∞ –ø–æ –≤–µ–ª–∏—á–∏–Ω–∏</label>
            <select id="pSizeMode">
              <option value="clothes">–û–±–ª–µ–∫–∞ (S‚Äì3XL)</option>
              <option value="jeans">–§–∞—Ä–º–µ—Ä–∫–∏/–ü–∞–Ω—Ç–∞–ª–æ–Ω–∏ (30‚Äì42)</option>
            </select>
            <div class="help">–í–Ω–µ—Å–∏ –∫–æ–ª–∏—á–∏–Ω–∞ –∑–∞ —Å–µ–∫–æ—ò–∞ –≤–µ–ª–∏—á–∏–Ω–∞. 0 –∑–Ω–∞—á–∏ –Ω–µ–º–∞.</div>
          </div>

          <div class="field" style="grid-column:1/-1;">
            <div id="sizeGrid"></div>
          </div>

          <div class="field" style="grid-column:1/-1;">
            <div class="row">
              <button class="btn primary" id="btnSaveProd">–ó–∞—á—É–≤–∞—ò –ø—Ä–æ–¥—É–∫—Ç</button>
              <span class="muted" id="saveHint"></span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
/* =========================
   Data + Storage
========================= */
const KEY = "mertax_store_v1";

const DEFAULT = {
  adminPass: "1234", // –º–æ–∂–µ—à –¥–∞ —ò–∞ —Å–º–µ–Ω–∏—à –≤–æ Admin
  categories: [
    {id: uid(), name:"–ù–æ–≤o"},
    {id: uid(), name:"–ê–∫—Ü–∏–∏"},
    {id: uid(), name:"–ñ–µ–Ω—Å–∫–∏"},
    {id: uid(), name:"–ú–∞—à–∫–∏"},
    {id: uid(), name:"–¢—Ä–µ–Ω–µ—Ä–∫–∏"},
    {id: uid(), name:"–à–∞–∫–Ω–∏"},
    {id: uid(), name:"–û–¥–µ–ª–∞"},
    {id: uid(), name:"–§–∞—Ä–º–µ—Ä–∫–∏/–ü–∞–Ω—Ç–∞–ª–æ–Ω–∏"},
  ],
  products: []
};

let state = load();
let session = { isAdmin:false, catId: state.categories[0]?.id || null, editingProdId:null };

function uid(){ return Math.random().toString(16).slice(2) + Date.now().toString(16); }

function load(){
  try{
    const raw = localStorage.getItem(KEY);
    if(!raw) return structuredClone(DEFAULT);
    const data = JSON.parse(raw);
    // basic healing
    if(!data.categories?.length) data.categories = structuredClone(DEFAULT.categories);
    if(!Array.isArray(data.products)) data.products = [];
    if(!data.adminPass) data.adminPass = DEFAULT.adminPass;
    return data;
  }catch(e){
    return structuredClone(DEFAULT);
  }
}
function save(){
  localStorage.setItem(KEY, JSON.stringify(state));
}

/* =========================
   UI helpers
========================= */
const UI = {
  open(id){ document.getElementById(id).classList.add("show"); },
  close(id){ document.getElementById(id).classList.remove("show"); },
  toast(msg){
    const el = document.getElementById("saveHint");
    if(el){ el.textContent = msg; setTimeout(()=> el.textContent="", 2200); }
  }
};

function money(n){
  const x = Number(n||0);
  return x.toLocaleString("mk-MK") + " –¥–µ–Ω";
}

/* =========================
   Sizes
========================= */
const CLOTHES = ["S","M","L","XL","2XL","3XL"];
const JEANS = ["30","31","32","33","34","36","38","40","42"];

function getSizeList(mode){
  return mode === "jeans" ? JEANS : CLOTHES;
}

/* =========================
   Render
========================= */
function renderCats(){
  const q = (document.getElementById("catSearch").value || "").trim().toLowerCase();
  const holder = document.getElementById("cats");
  holder.innerHTML = "";

  const cats = state.categories.filter(c => !q || c.name.toLowerCase().includes(q));
  cats.forEach(c=>{
    const count = state.products.filter(p=>p.catId===c.id).length;
    const div = document.createElement("div");
    div.className = "cat" + (session.catId===c.id ? " active":"");
    div.innerHTML = `<div><div class="name">${escapeHtml(c.name)}</div><div class="count">${count} –ø—Ä–æ–¥—É–∫—Ç–∏</div></div>
                     <div class="muted">‚Ä∫</div>`;
    div.onclick = ()=>{ session.catId=c.id; renderAll(); };
    holder.appendChild(div);
  });

  const active = state.categories.find(c=>c.id===session.catId) || state.categories[0];
  if(active) session.catId = active.id;
  document.getElementById("chipCatName").textContent = active ? active.name : "‚Äî";
}

function renderSizeFilterOptions(){
  const sel = document.getElementById("sizeFilter");
  const activeCat = session.catId;

  // collect sizes that exist and have stock >0 inside this category (based on current search)
  const prods = filteredProductsBase();
  const set = new Set();
  prods.forEach(p=>{
    Object.entries(p.stock || {}).forEach(([k,v])=>{
      if(Number(v)>0) set.add(k);
    });
  });

  const current = sel.value;
  sel.innerHTML = `<option value="">–§–∏–ª—Ç–µ—Ä –ø–æ –≤–µ–ª–∏—á–∏–Ω–∞ (—Å–∞–º–æ –¥–æ—Å—Ç–∞–ø–Ω–∏)</option>`;
  [...set].sort((a,b)=> a.localeCompare(b, 'mk')).forEach(s=>{
    const opt = document.createElement("option");
    opt.value = s;
    opt.textContent = s;
    sel.appendChild(opt);
  });

  // keep selection if still available
  if([...sel.options].some(o=>o.value===current)) sel.value = current;
}

function filteredProductsBase(){
  const activeCat = session.catId;
  const q = (document.getElementById("prodSearch").value || "").trim().toLowerCase();
  let prods = state.products.filter(p=>p.catId===activeCat);

  if(q){
    prods = prods.filter(p =>
      (p.name||"").toLowerCase().includes(q) ||
      (p.desc||"").toLowerCase().includes(q)
    );
  }
  return prods;
}

function renderProducts(){
  const cards = document.getElementById("cards");
  cards.innerHTML = "";

  const size = document.getElementById("sizeFilter").value || "";
  let prods = filteredProductsBase();

  if(size){
    prods = prods.filter(p => Number((p.stock||{})[size] || 0) > 0);
  }

  document.getElementById("prodInfo").textContent = `${prods.length} –ø—Ä–æ–¥—É–∫—Ç–∏`;

  prods.forEach(p=>{
    const imgs = (p.images||[]).filter(Boolean);
    const img = imgs[0] || "";
    const totalStock = Object.values(p.stock||{}).reduce((a,b)=>a+Number(b||0),0);
    const sold = totalStock<=0;

    const sizesHtml = Object.entries(p.stock||{})
      .filter(([k,v]) => Number(v)>=0)
      .sort((a,b)=>a[0].localeCompare(b[0], 'mk'))
      .slice(0, 10)
      .map(([k,v])=>{
        const z = Number(v||0);
        return `<span class="size"><span class="dot ${z<=0?'zero':''}"></span>${escapeHtml(k)} <span class="muted">(${z})</span></span>`;
      }).join("");

    const div = document.createElement("div");
    div.className = "card";
    div.innerHTML = `
      <div class="img">
        ${img ? `<img src="${escapeAttr(img)}" alt="${escapeAttr(p.name||'')}" onerror="this.style.display='none'; this.parentElement.style.background='rgba(0,0,0,.25)';">`
              : `<div style="height:100%;display:grid;place-items:center;color:rgba(255,255,255,.5);font-weight:700;">–ù–µ–º–∞ —Å–ª–∏–∫–∞</div>`}
        <span class="badge ${sold ? 'soldout':''}">${sold ? '–ù–µ–º–∞ –∑–∞–ª–∏—Ö–∞' : '–î–æ—Å—Ç–∞–ø–Ω–æ'}</span>
      </div>
      <div class="content">
        <div class="title">${escapeHtml(p.name || '–ë–µ–∑ –∏–º–µ')}</div>
        <div class="meta">
          <div class="price">${money(p.price)}</div>
          <div class="muted">${escapeHtml(catName(p.catId))}</div>
        </div>
        <div class="sizes">${sizesHtml || `<span class="muted">–ù–µ–º–∞ –≤–Ω–µ—Å–µ–Ω–∏ –≤–µ–ª–∏—á–∏–Ω–∏</span>`}</div>
        <div class="actions">
          <button class="btn blue" data-act="order">–ù–∞—Ä–∞—á–∞—ò</button>
          <button class="btn" data-act="view">–î–µ—Ç–∞–ª–∏</button>
        </div>
      </div>
    `;

    div.querySelector('[data-act="order"]').onclick = ()=> orderWhatsApp(p);
    div.querySelector('[data-act="view"]').onclick = ()=> openProductModal(p.id);
    cards.appendChild(div);
  });

  renderSizeFilterOptions();
}

function renderAll(){
  renderCats();
  renderProducts();
  renderAdminUI();
}

/* =========================
   Admin + Categories
========================= */
function renderAdminUI(){
  const st = document.getElementById("adminStatus");
  const tools = document.getElementById("adminTools");
  const logout = document.getElementById("btnLogout");
  const addCatBtn = document.getElementById("btnNewCat");
  const addProdBtn = document.getElementById("btnNewProd");

  if(session.isAdmin){
    st.textContent = "Admin";
    tools.style.display = "";
    logout.style.display = "";
    addCatBtn.disabled = false;
    addProdBtn.disabled = false;
  }else{
    st.textContent = "–ù–µ-–∞–¥–º–∏–Ω";
    tools.style.display = "none";
    logout.style.display = "none";
    addCatBtn.disabled = true;
    addProdBtn.disabled = true;
  }
}

function catName(id){
  return (state.categories.find(c=>c.id===id)||{}).name || "‚Äî";
}

function requireAdmin(){
  if(!session.isAdmin){
    UI.open("modalAdmin");
    alert("–°–∞–º–æ Admin –º–æ–∂–µ –¥–∞ –ø—Ä–∞–≤–∏ –ø—Ä–æ–º–µ–Ω–∏.");
    return false;
  }
  return true;
}

function openManageCats(){
  if(!requireAdmin()) return;
  document.getElementById("newCatName").value = "";
  renderCatAdminList();
  UI.open("modalCats");
}

function renderCatAdminList(){
  const box = document.getElementById("catAdminList");
  box.innerHTML = "";
  state.categories.forEach(c=>{
    const row = document.createElement("div");
    row.style.display="flex";
    row.style.gap="10px";
    row.style.alignItems="center";
    row.style.marginBottom="10px";
    row.innerHTML = `
      <div style="flex:1">
        <div class="muted" style="font-size:11px;">–ö–∞—Ç–µ–≥–æ—Ä–∏—ò–∞</div>
        <input class="input" value="${escapeAttr(c.name)}" data-id="${c.id}" />
      </div>
      <button class="btn blue" data-save="${c.id}">–ü—Ä–æ–º–µ–Ω–∏</button>
      <button class="btn danger" data-del="${c.id}">–ò–∑–±—Ä–∏—à–∏</button>
    `;
    row.querySelector(`[data-save="${c.id}"]`).onclick = ()=>{
      const inp = row.querySelector('input');
      const val = (inp.value||"").trim();
      if(!val) return alert("–ò–º–µ—Ç–æ –Ω–µ –º–æ–∂–µ –ø—Ä–∞–∑–Ω–æ.");
      renameCategory(c.id, val);
    };
    row.querySelector(`[data-del="${c.id}"]`).onclick = ()=>{
      deleteCategory(c.id);
    };
    box.appendChild(row);
  });
}

function addCategory(name){
  const n = (name||"").trim();
  if(!n) return;
  state.categories.push({id:uid(), name:n});
  save();
  renderAll();
}
function renameCategory(id, newName){
  const c = state.categories.find(x=>x.id===id);
  if(!c) return;
  c.name = newName;
  save();
  renderAll();
  renderCatAdminList();
}
function deleteCategory(id){
  if(state.categories.length<=1) return alert("–ú–æ—Ä–∞ –¥–∞ –∏–º–∞ –±–∞—Ä–µ–º 1 –∫–∞—Ç–µ–≥–æ—Ä–∏—ò–∞.");
  const hasProds = state.products.some(p=>p.catId===id);
  if(hasProds){
    if(!confirm("–û–≤–∞–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏—ò–∞ –∏–º–∞ –ø—Ä–æ–¥—É–∫—Ç–∏. –ê–∫–æ —ò–∞ –∏–∑–±—Ä–∏—à–µ—à, —Ç–∏–µ –ø—Ä–æ–¥—É–∫—Ç–∏ —ú–µ —Å–µ –ø—Ä–µ—Ñ—Ä–ª–∞—Ç –≤–æ –ø—Ä–≤–∞—Ç–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏—ò–∞. –ü—Ä–æ–¥–æ–ª–∂–∏?")) return;
    const fallback = state.categories.find(c=>c.id!==id);
    state.products.forEach(p=>{ if(p.catId===id) p.catId=fallback.id; });
  }
  state.categories = state.categories.filter(c=>c.id!==id);
  if(session.catId===id) session.catId = state.categories[0].id;
  save();
  renderAll();
  renderCatAdminList();
}

/* =========================
   Products
========================= */
function openProductModal(id){
  const p = state.products.find(x=>x.id===id);
  session.editingProdId = id || null;

  if(!p){
    if(!requireAdmin()) return;
  }

  document.getElementById("prodModalTitle").textContent = p ? "–£—Ä–µ–¥–∏ –ø—Ä–æ–¥—É–∫—Ç" : "–ù–æ–≤ –ø—Ä–æ–¥—É–∫—Ç";
  document.getElementById("btnDeleteProd").style.display = (p && session.isAdmin) ? "" : "none";

  // categories select
  const sel = document.getElementById("pCat");
  sel.innerHTML = "";
  state.categories.forEach(c=>{
    const o = document.createElement("option");
    o.value = c.id; o.textContent = c.name;
    sel.appendChild(o);
  });

  // fill fields
  document.getElementById("pName").value  = p?.name || "";
  document.getElementById("pPrice").value = p?.price ?? "";
  document.getElementById("pCat").value = p?.catId || session.catId || state.categories[0].id;
  document.getElementById("pWa").value = p?.wa || "";
  document.getElementById("pDesc").value = p?.desc || "";
  document.getElementById("pImages").value = (p?.images || []).join("\n");

  const mode = p?.sizeMode || (catName(document.getElementById("pCat").value).toLowerCase().includes("—Ñ–∞—Ä–º–µ—Ä–∫–∏") ? "jeans" : "clothes");
  document.getElementById("pSizeMode").value = mode;

  buildSizeGrid(mode, p?.stock || {});
  UI.open("modalProd");
}

function buildSizeGrid(mode, stock){
  const sizes = getSizeList(mode);
  const grid = document.getElementById("sizeGrid");
  grid.innerHTML = "";
  grid.style.display = "grid";
  grid.style.gridTemplateColumns = "repeat(auto-fill, minmax(150px,1fr))";
  grid.style.gap = "10px";

  sizes.forEach(s=>{
    const wrap = document.createElement("div");
    wrap.className = "field";
    wrap.innerHTML = `
      <label>${escapeHtml(s)}</label>
      <input type="number" min="0" step="1" data-size="${escapeAttr(s)}" value="${Number(stock?.[s]||0)}" />
    `;
    grid.appendChild(wrap);
  });
}

function collectStock(){
  const inputs = document.querySelectorAll('#sizeGrid input[data-size]');
  const stock = {};
  inputs.forEach(i=>{
    const k = i.getAttribute("data-size");
    const v = Math.max(0, parseInt(i.value||"0",10) || 0);
    stock[k]=v;
  });
  return stock;
}

function saveProduct(){
  if(!requireAdmin()) return;

  const name = (document.getElementById("pName").value||"").trim();
  const price = Number(document.getElementById("pPrice").value||0);
  const catId = document.getElementById("pCat").value;
  const wa = (document.getElementById("pWa").value||"").trim();
  const desc = (document.getElementById("pDesc").value||"").trim();
  const images = (document.getElementById("pImages").value||"")
    .split("\n").map(s=>s.trim()).filter(Boolean).slice(0,5);
  const sizeMode = document.getElementById("pSizeMode").value;
  const stock = collectStock();

  if(!name) return alert("–í–Ω–µ—Å–∏ –∏–º–µ –Ω–∞ –ø—Ä–æ–¥—É–∫—Ç.");
  if(!catId) return alert("–ò–∑–±–µ—Ä–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏—ò–∞.");

  const total = Object.values(stock).reduce((a,b)=>a+Number(b||0),0);
  // –¥–æ–∑–≤–æ–ª—É–≤–∞–º–µ –∏ 0 (–º–æ–∂–µ –¥–∞ –µ –≤–æ –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∞), –ø–∞ –Ω–µ –±–ª–æ–∫–∏—Ä–∞–º–µ

  if(session.editingProdId){
    const p = state.products.find(x=>x.id===session.editingProdId);
    if(!p) return;
    Object.assign(p, {name, price, catId, wa, desc, images, sizeMode, stock});
  }else{
    state.products.push({
      id: uid(),
      name, price, catId, wa, desc, images, sizeMode, stock,
      createdAt: Date.now()
    });
  }

  save();
  UI.toast("–ó–∞—á—É–≤–∞–Ω–æ ‚úÖ");
  UI.close("modalProd");
  renderAll();
}

function deleteProduct(){
  if(!requireAdmin()) return;
  const id = session.editingProdId;
  if(!id) return;
  if(!confirm("–°–∏–≥—É—Ä–Ω–æ —Å–∞–∫–∞—à –¥–∞ –≥–æ –∏–∑–±—Ä–∏—à–µ—à –ø—Ä–æ–¥—É–∫—Ç–æ—Ç?")) return;
  state.products = state.products.filter(p=>p.id!==id);
  save();
  UI.close("modalProd");
  renderAll();
}

function orderWhatsApp(p){
  // choose size
  const available = Object.entries(p.stock||{}).filter(([k,v])=>Number(v)>0).map(([k])=>k);
  if(available.length===0){
    alert("–û–≤–æ—ò –ø—Ä–æ–¥—É–∫—Ç –º–æ–º–µ–Ω—Ç–∞–ª–Ω–æ –Ω–µ–º–∞ –∑–∞–ª–∏—Ö–∞.");
    return;
  }
  const size = prompt("–í–Ω–µ—Å–∏ –≤–µ–ª–∏—á–∏–Ω–∞ (–¥–æ—Å—Ç–∞–ø–Ω–∏: " + available.join(", ") + ")", available[0]);
  if(!size) return;
  if(!available.includes(size)){
    alert("–ù–µ–º–∞ –∑–∞–ª–∏—Ö–∞ –∑–∞ —Ç–∞–∞ –≤–µ–ª–∏—á–∏–Ω–∞.");
    return;
  }
  const qtyStr = prompt("–ö–æ–ª–∏—á–∏–Ω–∞ (max " + p.stock[size] + "):", "1");
  if(!qtyStr) return;
  const qty = Math.max(1, parseInt(qtyStr,10) || 1);
  if(qty > p.stock[size]){
    alert("–ù–µ–º–∞–º–µ —Ç–æ–ª–∫—É –∑–∞–ª–∏—Ö–∞ –∑–∞ —Ç–∞–∞ –≤–µ–ª–∏—á–∏–Ω–∞.");
    return;
  }

  // reduce stock immediately (simulate order)
  p.stock[size] = Math.max(0, Number(p.stock[size]) - qty);
  save();
  renderAll();

  const phone = (p.wa || "").replace(/\D/g,"");
  if(!phone){
    alert("–ù–µ–º–∞ –≤–Ω–µ—Å–µ–Ω WhatsApp –±—Ä–æ—ò –∑–∞ –æ–≤–æ—ò –ø—Ä–æ–¥—É–∫—Ç. (Admin -> –≤–Ω–µ—Å–∏ –±—Ä–æ—ò)");
    return;
  }

  const msg =
`–ó–¥—Ä–∞–≤–æ, —Å–∞–∫–∞–º –¥–∞ –Ω–∞—Ä–∞—á–∞–º:
‚Ä¢ –ü—Ä–æ–¥—É–∫—Ç: ${p.name}
‚Ä¢ –ö–∞—Ç–µ–≥–æ—Ä–∏—ò–∞: ${catName(p.catId)}
‚Ä¢ –¶–µ–Ω–∞: ${money(p.price)}
‚Ä¢ –í–µ–ª–∏—á–∏–Ω–∞: ${size}
‚Ä¢ –ö–æ–ª–∏—á–∏–Ω–∞: ${qty}

(–ü—Ä–∞—Ç–µ–Ω–æ –æ–¥ MertaX Butik)`;

  const url = "https://wa.me/" + phone + "?text=" + encodeURIComponent(msg);
  window.open(url, "_blank");
}

/* =========================
   Security-ish (local only)
========================= */
function login(pass){
  if((pass||"") === state.adminPass){
    session.isAdmin = true;
    return true;
  }
  return false;
}
function logout(){
  session.isAdmin = false;
  renderAll();
}
function changeAdminPass(newPass){
  const p = (newPass||"").trim();
  if(p.length < 4) return alert("–õ–æ–∑–∏–Ω–∫–∞—Ç–∞ –Ω–µ–∫–∞ –±–∏–¥–µ –±–∞—Ä–µ–º 4 –∫–∞—Ä–∞–∫—Ç–µ—Ä–∏.");
  state.adminPass = p;
  save();
  alert("–õ–æ–∑–∏–Ω–∫–∞—Ç–∞ –µ —Å–º–µ–Ω–µ—Ç–∞ ‚úÖ");
}

/* =========================
   Events
========================= */
document.getElementById("catSearch").addEventListener("input", renderCats);
document.getElementById("prodSearch").addEventListener("input", renderProducts);
document.getElementById("sizeFilter").addEventListener("change", renderProducts);

document.getElementById("btnAdmin").onclick = ()=> UI.open("modalAdmin");

document.getElementById("btnLogin").onclick = ()=>{
  const pass = document.getElementById("adminPass").value || "";
  if(login(pass)){
    document.getElementById("adminPass").value = "";
    renderAll();
    alert("–õ–æ–≥–∏—Ä–∞–Ω–æ –∫–∞–∫–æ Admin ‚úÖ");
  }else{
    alert("–ü–æ–≥—Ä–µ—à–Ω–∞ –ª–æ–∑–∏–Ω–∫–∞ ‚ùå");
  }
};

document.getElementById("btnLogout").onclick = ()=> logout();

document.getElementById("btnChangePass").onclick = ()=>{
  if(!requireAdmin()) return;
  changeAdminPass(document.getElementById("newAdminPass").value);
  document.getElementById("newAdminPass").value = "";
};

document.getElementById("btnManageCats").onclick = openManageCats;

document.getElementById("btnNewCat").onclick = openManageCats;
document.getElementById("btnAddCat2").onclick = ()=>{
  if(!requireAdmin()) return;
  const name = document.getElementById("newCatName").value;
  if(!name.trim()) return;
  addCategory(name);
  document.getElementById("newCatName").value="";
  renderCatAdminList();
};

document.getElementById("btnNewProd").onclick = ()=> openProductModal(null);
document.getElementById("btnSaveProd").onclick = saveProduct;
document.getElementById("btnDeleteProd").onclick = deleteProduct;

document.getElementById("pSizeMode").addEventListener("change", (e)=>{
  buildSizeGrid(e.target.value, {});
});

document.getElementById("pCat").addEventListener("change", (e)=>{
  // auto switch size mode if category is jeans
  const name = catName(e.target.value).toLowerCase();
  if(name.includes("—Ñ–∞—Ä–º–µ—Ä–∫–∏") || name.includes("–ø–∞–Ω—Ç–∞–ª–æ–Ω–∏")){
    document.getElementById("pSizeMode").value = "jeans";
    buildSizeGrid("jeans", collectStock());
  }
});

/* =========================
   Helpers
========================= */
function escapeHtml(s){
  return String(s||"")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}
function escapeAttr(s){ return escapeHtml(s).replaceAll("\n"," "); }

/* =========================
   Seed demo products (optional)
========================= */
if(state.products.length===0){
  // 2 –ø—Ä–∏–º–µ—Ä –ø—Ä–æ–¥—É–∫—Ç–∏ –¥–∞ —Å–µ –≤–∏–¥–∏ –¥–∏–∑–∞—ò–Ω
  const catNew = state.categories[0].id;
  const catJeans = state.categories.find(c=>c.name.toLowerCase().includes("—Ñ–∞—Ä–º–µ—Ä–∫–∏"))?.id || catNew;

  state.products.push({
    id: uid(),
    name:"–¢—Ä–µ–Ω–µ—Ä–∫–∞ - –ø—Ä–∏–º–µ—Ä",
    price: 1990,
    catId: catNew,
    wa: "38970xxxxxx",
    desc:"–ü—Ä–∏–º–µ—Ä –ø—Ä–æ–¥—É–∫—Ç. Admin -> —É—Ä–µ–¥–∏ –∏ —Å—Ç–∞–≤–∏ —Å–≤–æ–∏ —Å–ª–∏–∫–∏/–∑–∞–ª–∏—Ö–∞.",
    images: [],
    sizeMode:"clothes",
    stock: {S:2,M:3,L:1,XL:0,"2XL":0,"3XL":0},
    createdAt: Date.now()
  });
  state.products.push({
    id: uid(),
    name:"–§–∞—Ä–º–µ—Ä–∫–∏ - –ø—Ä–∏–º–µ—Ä",
    price: 2490,
    catId: catJeans,
    wa: "38970xxxxxx",
    desc:"–ü—Ä–∏–º–µ—Ä –∑–∞ –±—Ä–æ—ò–∫–∏ 30-42.",
    images: [],
    sizeMode:"jeans",
    stock: {"30":1,"31":1,"32":2,"33":0,"34":1,"36":0,"38":0,"40":0,"42":0},
    createdAt: Date.now()
  });
  save();
}

/* init */
renderAll();
</script>
</body>
</html>
